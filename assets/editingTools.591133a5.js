var Gi=Object.defineProperty,Ai=Object.defineProperties;var Ri=Object.getOwnPropertyDescriptors;var la=Object.getOwnPropertySymbols;var Di=Object.prototype.hasOwnProperty,Ti=Object.prototype.propertyIsEnumerable;var ha=(t,e,a)=>e in t?Gi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a,G=(t,e)=>{for(var a in e||(e={}))Di.call(e,a)&&ha(t,a,e[a]);if(la)for(var a of la(e))Ti.call(e,a)&&ha(t,a,e[a]);return t},D=(t,e)=>Ai(t,Ri(e));import{dh as ti,G as ie,aM as $,cP as N,di as $i,dj as X,dk as ca,aJ as nt,cc as ot,cb as P,dl as lt,cX as ht,dm as Ii,dn as V,br as E,O as c,V as y,bh as de,d5 as Ft,c2 as Wt,dp as Ut,dq as st,dr as fe,ds as Te,cB as je,cU as pa,dt as Pi,du as Vi,dv as xt,dw as zi,bg as Et,dx as Ci,dy as Qt,dz as Rt,bf as te,dA as b,dB as Li,dC as Y,l as Me,c0 as z,dD as Ke,cQ as Se,dE as Hi,dF as Lt,dG as Ni,dH as da,dI as ct,dJ as ki,cJ as F,b0 as Pe,ac as Ze,Z as C,dK as Fi,J as m,K as _,L as Ee,dL as j,dM as ai,dN as L,dc as Dt,dO as Bt,bi as be,aN as Ui,aH as Bi,dP as Zi,dQ as ii,dR as Yi,dS as Xi,dT as ji,ap as we,cz as ae,dU as rt,dV as Jt,dW as qi,dX as qe,dY as ua,dZ as Z,d_ as S,d$ as Wi,e0 as bt,e1 as ni,e2 as wt,e3 as Kt,e4 as Tt,cu as si,cE as Qi,e5 as ri,e6 as pe,e7 as Ji,ca as Ot,cd as xe,e8 as Ki,e9 as en,ea as oi,az as tn,eb as an,ec as Fe,cs as li,ct as $t,a9 as nn,ed as sn,ee as hi,cC as It,ef as $e,eg as Zt,eh as rn,ei as on,cD as ln,ej as hn,db as ut,c_ as ci,d1 as pi,cZ as ea,ek as cn,el as ga,$ as ta,em as et,b3 as Ge,en as ma,eo as pn,ep as Ye,eq as dn,er as un,c1 as gn,es as di,et as _a,eu as he,ev as mn,ew as _n,ex as vn,ey as yn,ez as ui,eA as Yt,eB as gi,eC as fn,eD as pt,eE as va,eF as Mn,eG as ya,eH as fa,eI as mi,aa as _i,eJ as vi,cy as yi,aG as Xt,j as Sn,eK as fi,eL as bn,eM as Ma,eN as Sa,de as ba,eO as Ue,eP as ke,d6 as xa,eQ as xn,eR as En,eS as wn,eT as On,eU as Gn,eV as An,eW as Rn,eX as Dn,eY as Tn,eZ as $n,cp as Ea,e_ as _e,e$ as wa,f0 as _t,f1 as Oa,c4 as In,f2 as Pn,f3 as Vn,f4 as zn,f5 as Cn,f6 as Ln,f7 as Hn,f8 as Nn,f9 as kn,fa as Fn}from"./vendor.c28ea743.js";import{a as Un,M as aa,T as Bn,y as d,e as ze,S as Ve,r as ia}from"./GraphicState.c7116edc.js";import{z as Zn}from"./RightAngleQuadVisualElement.94368e72.js";import{r as Yn,e as Gt}from"./SnappingContext.cefda3df.js";import{_ as Xn,b as jn,G as qn,n as Wn,r as Qn,a as At}from"./drawSurfaces.67c070e0.js";import{q as Jn}from"./colorUtils.7c4b6dc5.js";import{v as Kn}from"./GraphicManipulator.c1300f03.js";import{S as Pt,X as es,T as Ga,E as ce,t as ts,a as as,s as is,c as ns,e as Aa}from"./EditGeometryOperations.589e5ad2.js";import{l as ss,v as rs}from"./axisAngleDegrees.fc4feeae.js";import"./PointSnappingHint.439445c9.js";import"./drapedUtils.afb6a99b.js";class os extends ti{constructor(e){super(e),this._handles=new ie,this._location=$(),this._direction=N(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=$i(1,0,1,1),this._renderOccluded=X.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){ca(this._location,e)||(nt(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){ca(this._direction,e)||(nt(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,a){ot(this._direction,P(this._direction,a,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){lt(e,this._color)||(ht(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new Ii(this.materialParameters);this._handles.add(this.view.state.watch("camera",()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const a=V.createPolylineGeometry([$(),$()]),i=V.createPolylineGeometry([$(),$()]),n=E(this._externalResources).material;e.addGeometry(a,n),e.addGeometry(i,n),this._updateVertices(e)}forEachExternalMaterial(e){c(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){y(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;y(e)||this._updateVertices(e)}_updateVertices(e){const a=this.view.state.camera;a.projectToScreen(this.location,vt),de(se,this.location,this.direction),a.projectToScreen(se,Ce),Ft(Ce,Wt(Ce,Ce,vt)),this._updateVertexAttributes(a,e,0,vt,Ce,1),this._updateVertexAttributes(a,e,1,vt,Ce,-1)}_updateVertexAttributes(e,a,i,n,s,r){const o=a.geometryRecords[i],l=o.geometry.getMutableAttribute(Ut.POSITION).data,h=st(Ra,fe(Ra,s[1]*r,s[0]*-r),this.offset+this.width/2),p=Te(yt,Te(yt,Te(yt,n,st(yt,s,this.length/2)),h),h),g=Te(Da,p,st(Da,s,-this.length));e.unprojectFromScreen(p,se),l[0]=se[0],l[1]=se[1],l[2]=se[2],e.unprojectFromScreen(g,se),l[3]=se[0],l[4]=se[1],l[5]=se[2],a.geometryVertexAttrsUpdated(o)}}const se=$(),vt=je(),Ce=je(),Ra=je(),yt=je(),Da=je();class jt{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=pa(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=pa(1,1,1,1),this._elevationInfo=null,this.resources=new Un({view:e.view,createResources:i=>this._createResources(i),recreateGeometry:(i,n)=>(i.geometry=this._recreateGeometry(n,i.material),c(i.geometry)?[i.geometry]:[])});let a=!0;for(const i in e)i in this?i==="attached"?a=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=a}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const a=this.preferredTextureSize;this._size=e,a<this.preferredTextureSize?c(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){lt(e,this._color)||(ht(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,c(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){lt(e,this._outlineColor)||(ht(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;y(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,a=this.resources.object;if(y(e)||y(a))return;const i=e.geometry;if(y(i))return;const n=i.getMutableAttribute(Ut.SIZE).data,s=this.geometrySize;n[0]=s,n[1]=s,a.geometryVertexAttrsUpdated(a.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:ls,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/it}_recreateGeometry(e,a){const i=this._createRenderGeometry();return c(i)&&e.addGeometry(i,a),i}_createResources(e){const a=Pi(this._primitive,this.preferredTextureSize),i=new Vi(this._materialParameters(a.id)),n=this._recreateGeometry(e,i);return{material:i,texture:a,geometry:n,forEach(s){s(a),s(i),c(this.geometry)&&s(this.geometry)}}}get preferredTextureSize(){return xt(zi(2*this.geometrySize),16,128)}calculateMapBounds(e){if(y(this.resources.resources)||y(this.resources.resources.geometry))return!1;const a=this.resources.resources.geometry.vertexAttributes.get(Ut.POSITION);return Et(a.data,this.view.renderCoordsHelper.spatialReference,Ta,this.view.spatialReference),Ci(e,Ta),!0}_createRenderGeometry(){const e=this.geometry;if(y(e))return null;const{renderCoordsHelper:a,elevationProvider:i}=this.view,n=Qt(e,i,Rt.fromElevationInfo(this.elevationInfo),a),s=te(b.get(),e.x,e.y,n),r=b.get();Et(s,e.spatialReference,r,a.spatialReference);const o=this.geometrySize;return V.createPointGeometry(null,r,null,[o,o],[0,0,0,1])}}const it=Li,ls=[it/2,it/2,1-it/2,1-it/2],Ta=$();class dt extends Yn{visualizeIntersectionPoint(e,a){const{coordinateHelper:i,elevationInfo:n,view:s}=a;return Y(new jt({view:s,primitive:"circle",geometry:i.vectorToPoint(e.intersectionPoint),elevationInfo:n,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:Me.toUnitRGBA(z.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,a){const{coordinateHelper:i,elevationInfo:n,view:s}=a;return Y(new jt({view:s,primitive:"circle",geometry:i.vectorToPoint(e.point),elevationInfo:n,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:Me.toUnitRGBA(z.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,a){const{coordinateHelper:i,elevationInfo:n,view:s}=a;return Y(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,i,n,s,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,a){const{coordinateHelper:i,elevationInfo:n,view:s}=a,r=Ke(e.lineStart,i,n,a.view),o=Ke(e.lineEnd,i,n,a.view),l=Se(o,r,o,.5),h=new os({view:s,attached:!1,offset:z.parallelLineHintOffset,length:z.parallelLineHintLength,width:z.parallelLineHintWidth,color:Me.toUnitRGBA(z.orange),location:l,renderOccluded:X.Opaque});return h.setDirectionFromPoints(r,l),h.attached=!0,Y(h)}visualizeRightAngleQuad(e,a){const{coordinateHelper:i,elevationInfo:n,view:s}=a;return Y(new Zn({view:s,attached:!0,color:Me.toUnitRGBA(z.orange),renderOccluded:X.Transparent,outlineRenderOccluded:X.Opaque,outlineColor:Me.toUnitRGBA(z.orange),outlineSize:z.rightAngleHintOutlineSize,size:z.rightAngleHintSize,geometry:{previous:Ke(e.previousVertex,i,n,s),center:Ke(e.centerVertex,i,n,s),next:Ke(e.nextVertex,i,n,s)}}))}_createLineSegmentHintFromMap(e,a,i,n,s,r,o=!0,l=!0){const h=$(),p=$();return Hi(a,i,n,s,r,h,p),this._createLineSegmentHint(e,r,h,p,o,l)}_createLineSegmentHint(e,a,i,n,s=!0,r=!0){const o=new aa({view:a,extensionType:Bn.FADED,start:i,end:n,color:Me.toUnitRGBA(z.orange),renderOccluded:X.Opaque});switch(e){case Lt.TARGET:o.width=z.lineHintWidthTarget,o.fadedExtensions={start:0,end:z.lineHintFadedExtensions};break;case Lt.REFERENCE_EXTENSION:o.width=z.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case Lt.REFERENCE:o.width=z.lineHintWidthReference,o.fadedExtensions={start:s?z.lineHintFadedExtensions:0,end:r?z.lineHintFadedExtensions:0}}return o.attached=!0,o}}class $a extends ti{constructor(e){super(e),this.view=null,this._renderOccluded=X.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=d.colorToVec4(d.reshapeManipulators.vertex.color),this._size=d.reshapeManipulators.vertex.size,this._outlineColor=d.colorToVec4(d.reshapeManipulators.vertex.outlineColor),this._outlineSize=d.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){lt(e,this._color)||(ht(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){lt(e,this._outlineColor)||(ht(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(y(e)||e.length===0)return[];const a=.5,i=.5,n=Ni(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Rt.fromElevationInfo(this.elevationInfo)),s=[],r=n.numVertices,o=n.position;for(let l=0;l<r;++l){const h=te(hs,o[3*l+0],o[3*l+1],o[3*l+2]),p=Ia(a,h),g=Ia(i,h);s.push({vertexGeometry:p,vertexOutlineGeometry:g})}return s}createGeometries(e){const a=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:n}of a)e.addGeometry(i,this.vertexMaterial),e.addGeometry(n,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new da(D(G({},this.vertexMaterialParameters),{writeDepth:!0,cullFace:ct.Back,screenSizeEnabled:!0})),this.vertexOutlineMaterial=new da(D(G({},this.vertexOutlineMaterialParameters),{transparent:!0,writeDepth:!0,cullFace:ct.Front,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const hs=$();function Ia(t,e){return V.createSphereGeometry(t,16,16,{offset:e})}let Le=class extends Xn{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new ki({mode:t,offset:e})}normalizeCtorArgs(t){if(!t.elevationInfo){var e;const a=(e=t.hasZ)==null||e;return D(G({},t),{elevationInfo:{mode:a?"absolute-height":"on-the-ground",offset:0}})}return t}initializeGraphic(t){return this._createGraphicState=new ze({graphic:t}),F([this.view.maskOccludee(t),this.view.trackGraphicState(this._createGraphicState),Pe(this._createGraphicState,"isDraped",e=>{c(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)})])}makeDrawOperation(){return new jn({view:this.view,manipulators:this.manipulators,geometryType:qn(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Wn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Qn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new dt})}onActiveVertexChanged(t){return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new $a({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:d.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=d.colorToVec4(d.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,Ze(()=>{this._activeVertexVisualElement=C(this._activeVertexVisualElement)}))}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Ve({view:this.view,geometry:t,elevationInfo:e,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Fi(this.hasZ,e)==="on-the-ground",attached:!1}),d.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),d.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Ze(()=>{this._outlineVisualElement=C(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new $a({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:d.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Ze(()=>{this._verticesVisualElement=C(this._verticesVisualElement)}))}};m([_({constructOnly:!0})],Le.prototype,"elevationInfo",void 0),m([_({constructOnly:!0})],Le.prototype,"geometryType",void 0),m([_({readOnly:!0})],Le.prototype,"type",void 0),m([_({constructOnly:!0,nonNullable:!0})],Le.prototype,"view",void 0),Le=m([Ee("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Le);var ee;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(ee||(ee={}));var O;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(O||(O={}));class Mi{constructor(){this.grabbingState=ee.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=ee.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((a,i)=>{if(i===O.TRANSLATE_Z&&(this.zManipulator=a),a instanceof j&&(a.selected&&(this.numSelected===0&&(this.firstSelected=a),this.numSelected++),y(this.firstGrabbedXY)&&a.grabbing&&i===O.TRANSLATE_XY&&(this.firstGrabbedXY=a)),a.grabbing)switch(this.grabbingState|=ee.ANY,i){case O.TRANSLATE_Z:this.grabbingState|=ee.Z;break;case O.TRANSLATE_XY:this.grabbingState|=ee.XY}})}}function cs(t){const{view:e,graphic:a}=t,i=new ze({graphic:a}),n=ps(t,i),s=[n,ds(t,n.visualElement,i),e.maskOccludee(a),e.trackGraphicState(i)];return{visualElement:n.visualElement,remove:()=>F(s).remove()}}function ps(t,e){const{view:a,graphic:i}=t,n=new Ve({view:a,geometry:qt(i)?i.geometry:null,elevationInfo:L(i),attached:!1});d.visualElements.lineGraphics.shadowStyle.apply(n);const s=()=>{n.attached=e.displaying};d.visualElements.lineGraphics.outline.apply(n);const r=[e.watch("displaying",s),e.watch("isDraped",o=>n.isDraped=o),e.on("changed",()=>n.geometry=qt(i)?i.geometry:null),Y(n)];return s(),{visualElement:n,remove:()=>F(r).remove()}}function ds(t,e,a){const{graphic:i,view:n}=t,s=[],r=L(i),o=r.mode==="on-the-ground"||!r.offset&&r.mode!=="absolute-height",l=new Mi,h=new aa({view:n,extensionType:d.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:X.OccludeAndTransparent});d.visualElements.pointGraphics.shadowStyle.apply(h);const p=Dt(d.visualElements.heightPlaneAngleCutoff),g=new Bt({view:n,attached:!1,angleCutoff:p});d.visualElements.heightPlane.apply(g);let u=1,v=1;const f=()=>{if(l.update(t),!a.displaying||o&&(a.isDraped||!qt(i)||!i.geometry.hasZ))return e.laserlineEnabled=!1,h.attached=!1,void(g.attached=!1);e.laserlineEnabled=!0;{const M=l.grabbingState&ee.XY?d.visualElements.laserlineAlphaMultiplier:1;M!==u&&(u=M,d.visualElements.lineGraphics.shadowStyle.apply(e,M),d.visualElements.pointGraphics.shadowStyle.apply(h,M))}{const M=l.grabbingState&ee.Z?d.visualElements.laserlineAlphaMultiplier:1;M!==v&&(v=M,d.visualElements.heightPlane.apply(g,M))}us(h,l),gs(t,e,g,l)};d.visualElements.zVerticalLine.apply(h),s.push(a.on("changed",f),a.watch("displaying",f),e.events.on("attachment-origin-changed",f),Y(h),Y(g));const w=[],A=()=>{F(w).remove(),w.length=0,t.forEachManipulator(M=>w.push(M.events.on("grab-changed",f))),t.forEachManipulator(M=>w.push(M.events.on("select-changed",f))),f()};return A(),s.push(t.onManipulatorsChanged(A),ai(()=>F(w))),F(s)}function us(t,e){const a=e.numSelected===1?e.firstSelected:e.numSelected>1&&c(e.firstGrabbedXY)?e.firstGrabbedXY:null;c(a)?(t.setStartEndFromWorldDownAtLocation(a.renderLocation),t.attached=!0):t.attached=!1}function gs(t,e,a,i){if(i.numSelected>0){te(Ae,0,0,0);let n=0;t.forEachManipulator((s,r)=>{r===O.TRANSLATE_XY&&s.selected&&s instanceof j&&(de(Ae,Ae,s.renderLocation),n++)}),n>0?(a.heightManifoldTarget=be(Ae,Ae,1/n),a.attached=!0):a.attached=!1}else{const n=e.attachmentOrigin;c(n)&&t.view.renderCoordsHelper.toRenderCoords(n,Ae)?(a.heightManifoldTarget=Ae,a.attached=!0):a.attached=!1}}function qt(t){return c(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const Ae=$();function ms(t){const{view:e,graphic:a}=t,i=new ze({graphic:a}),n=[],s=vs(t,i,n);return _s(t,i,n,s),n.push(e.trackGraphicState(i)),{visualElement:s,remove(){F(n).remove()}}}function _s(t,e,a,i){const{view:n,graphic:s}=t,r=new aa({view:n,extensionType:d.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:X.OccludeAndTransparent});d.visualElements.zVerticalLine.apply(r);const o=new Bt({view:n,intersectsLineInfinite:!0,attached:!1});d.visualElements.pointGraphics.shadowStyle.apply(o);const l=Dt(d.visualElements.heightPlaneAngleCutoff),h=new Bt({view:n,attached:!1,angleCutoff:l});d.visualElements.heightPlane.apply(h);const p=L(t.graphic),g=Rt.fromElevationInfo(p),u=p.mode==="on-the-ground"||!p.offset&&p.mode!=="absolute-height",v=new Mi;let f=1,w=1;const A=()=>{v.update(t);const M=na(s),R=u&&(e.isDraped||y(M)||!M.hasZ);let U=!0;if(!R&&c(M)){const I=Qt(M,n.elevationProvider,g,n.renderCoordsHelper);te(J,M.x,M.y,I),Et(J,M.spatialReference,J,n.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(J),o.intersectsWorldUpAtLocation=J}else U=!1;const We=v.grabbingState&ee.Z?d.visualElements.laserlineAlphaMultiplier:1;We!==f&&(f=We,d.visualElements.heightPlane.apply(h,We));const Qe=Bi(Ss);!R&&e.displaying&&i.calculateMapBounds(Qe)&&Et(Zi(Qe,J),n.spatialReference,J,n.renderCoordsHelper.spatialReference)?(h.heightManifoldTarget=J,h.attached=!0):h.attached=!1;const oe=v.grabbingState&ee.XY?d.visualElements.laserlineAlphaMultiplier:1;oe!==w&&(w=oe,d.visualElements.pointGraphics.shadowStyle.apply(o,oe));const mt=U&&e.displaying&&!R;o.attached=mt,r.attached=mt};a.push(e.watch(["displaying","isDraped"],A),e.on("changed",A)),t.forEachManipulator(M=>{a.push(M.events.on("grab-changed",A))}),a.push(Y(o)),a.push(Y(r)),a.push(Y(h)),A()}function vs(t,e,a){const{view:i,graphic:n}=t,s=new jt({view:i,geometry:na(n),elevationInfo:L(n),attached:!1});return ys(t,s,e,a),a.push(Y(s)),s}function na(t){const e=t.geometry;return y(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function ys(t,e,a,i){const n=()=>e.attached=a.displaying;fs(t,e,a,i),d.visualElements.pointGraphics.outline.apply(e),i.push(Pe(a,"displaying",n))}function fs(t,e,a,i){const{view:n,graphic:s}=t;let r=null;const o=h=>{c(r)&&(r.remove(),r=null),a.isDraped&&c(h)&&(r=Ms(n,h,()=>{e.geometry=h}))},l=()=>{const h=na(s);o(h),e.geometry=h};i.push(a.on("changed",l),ai(()=>r)),l()}function Ms(t,e,a){const i=t.elevationProvider.spatialReference;Yi(e,J,i);const n=J[0],s=J[1];return t.elevationProvider.on("elevation-change",r=>{ii(r.extent,n,s)&&a()})}const J=$(),Ss=Ui();function Vt(t){switch(E(t.graphic.geometry).type){case"point":case"mesh":return ms(t);case"polygon":case"polyline":return cs(t);default:return null}}const bs=[1,.5,0],Si=128,re=70,xs=80,bi=.02,Es=54,ws=100,xi=Math.ceil(re/3*2),De=160,Ht=.5,Nt=24,He=9,Os=De+30,Pa=De+53,Gs=60,As=23,Rs=5*Math.PI/12,Ds=1*Math.PI/3,Va=10,za=.2,Ca=30,La=53,Ha=.2,Na=.3,Ts=200,$s=3,Is=1e6;class gt{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(a=>a.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(a=>a.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(a=>a.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(a=>{e||(e=a.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(a=>a.available=e)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(a=>a===e)}someManipulator(e){let a=!1;return this.forEachManipulator(i=>{!a&&e(i)&&(a=!0)}),a}_forEachManipulator3D(e){this.forEachManipulator((a,i)=>{a instanceof j&&e(a,i)})}}function zt(t,e,a,i){const n=t.graphic,s=(r,o)=>e({action:r,graphic:n,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY});return a((r,o,l)=>{const h=o.next(p=>(p.action==="start"&&s("start",p),p)).next(Xi(n,i)).next(p=>{switch(p.action){case"start":case"update":(p.translationX||p.translationY||p.translationZ)&&s("update",p);break;case"end":s("end",p)}return p});return l.next(ji(n)).next(()=>{s("end",{screenDeltaX:0,screenDeltaY:0})}),h})}function Ei(t){if(y(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const a=e[0],i=e[1];return Math.atan2(i[1]-a[1],i[0]-a[0])}class Ps extends gt{constructor(e){super(),this._handles=new ie,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=re,this._updateAfterDrag=!1,this.events=new we,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(a=>this._tool.manipulators.add(a))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=C(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:a}of this._arrowManipulatorInfos)e(a,O.TRANSLATE_XY)}createGraphicDragPipeline(e,a,i){const n=a.graphic,s=L(n),r=E(n.geometry).spatialReference;return zt(a,i,o=>this.createDragPipeline((l,h,p,g,u)=>o(l,e(l,h,p,g,u),p),s,r,n),this._view.state.viewingMode)}createDragPipeline(e,a,i,n){return F(this._arrowManipulatorInfos.map(({manipulator:s},r)=>ae(s,(o,l,h,p,g)=>{const u=l.next(v=>D(G({},v),{manipulatorType:O.TRANSLATE_XY})).next(rt(this._view,o.elevationAlignedLocation)).next(Jt(this._view,o.elevationAlignedLocation,a,i,n)).next(qi(o.location,this.angle+(r+1)*Math.PI*.5)).next(qe());e(o,u,h,p,g)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:a},i){const n=this._radius/re,s=Es*n,r=s*Math.sqrt(3)/2,o=V.createExtrudedTriangle(r,s/2,s/2,bi);V.transformInPlace(o,ua(Z.get(),te(b.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:S.Focused},{geometry:o,material:this._transparentMaterial,stateMask:S.Unfocused}],e.radius=r/3*2*1.2;const l=Wi(Z.get(),i*Math.PI/2),h=ua(Z.get(),te(b.get(),0,ws*n,0));bt(a,l,h)}_createManipulators(){for(let e=0;e<4;e++){const a=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(a)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,a=ni(Z.get(),e,N(0,0,1)),i=wt(Z.get(),te(b.get(),this.displayScale,this.displayScale,this.displayScale)),n=bt(Z.get(),i,a);for(const s of this._arrowManipulatorInfos){const r=bt(Z.get(),n,s.transform);s.manipulator.modelTransform=r}}_createArrowManipulator(e){const a=new j({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)}}),i={manipulator:a,transform:Tt()};return this._updateArrowManipulator(i,e),this._handles.add(a.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),i}_createMaterial(e=1){const a=Me.toUnitRGBA(ia.main);return a[3]*=e,new Kt({color:a,transparent:e!==1,cullFace:ct.Back,renderOccluded:X.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class Vs{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new si,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const a=this.lastDragEvent.mapEnd,i=this._snap(this.lastDragEvent.screenEnd);if(c(i)){const n={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:e===!0?i:a,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(n)}}this._enabled=e}_snap(e){const a=c(this.view)?this.view.toMap(e,{exclude:[]}):null;return c(a)&&c(this.view)&&(a.z=Qi(a,this.view,this.elevationInfo)),a}createDragEventPipelineStep(e,a){return this.view=e,this.elevationInfo=a,this.lastDragEvent=null,i=>{if(this.lastDragEvent=i.action!=="end"?G({},i):null,this._enabled){const n=this._snap(i.screenEnd);return c(n)?{action:i.action,mapStart:i.mapStart,mapEnd:n,screenStart:i.screenStart,screenEnd:i.screenEnd}:null}return{action:i.action,mapStart:i.mapStart,mapEnd:i.mapEnd,screenStart:i.screenStart,screenEnd:i.screenEnd}}}}class zs extends gt{constructor(e){super(),this._handles=new ie,this._snapToScene=new Vs,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=re,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(a=>this._tool.manipulators.add(a))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,O.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,a,i){const n=a.graphic,s=L(n),r=E(n.geometry).spatialReference;return zt(a,i,o=>this.createDragPipeline((l,h,p,g,u)=>o(l,e(l,h,p,g,u),p),s,r,n),this._view.state.viewingMode)}createDragPipeline(e,a,i,n){const s=this._view;return ae(this._manipulator,(r,o,l,h,p)=>{const g=o.next(rt(s,r.elevationAlignedLocation)).next(Jt(s,r.elevationAlignedLocation,a,i,n)).next(this._snapToScene.createDragEventPipelineStep(s,a),this._snapToScene.next).next(u=>D(G({},u),{manipulatorType:O.TRANSLATE_XY})).next(qe());e(r,g,l,h,p)})}_updateManipulatorTransform(){const e=wt(Z.get(),te(b.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new j({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=V.createCylinderGeometry(bi,1,Si,N(0,0,1),N(0,0,0)),a=wt(Tt(),N(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:a,stateMask:S.Focused},{geometry:e,material:this._discMaterialTransparent,transform:a,stateMask:S.Unfocused}],this._manipulator.radius=xs*(this._radius/re)}_createMaterial(e=1){const a=Me.toUnitRGBA(ia.main);return a[3]*=e,new Kt({color:a,transparent:e!==1,cullFace:ct.Back,renderOccluded:X.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Cs extends gt{constructor(e){super(),this._handles=new ie,this._radius=re,this.events=new we,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(a=>this._tool.manipulators.add(a))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,O.TRANSLATE_Z)}createGraphicDragPipeline(e,a,i){const n=E(a.graphic.geometry).spatialReference;return zt(a,i,s=>this.createDragPipeline((r,o,l,h,p)=>s(r,e(r,o,l,h,p),l),n),this._view.state.viewingMode)}createDragPipeline(e,a){const i=this._view;return ae(this._manipulator,(n,s,r,o,l)=>{const h=s.next(p=>D(G({},p),{manipulatorType:O.TRANSLATE_Z})).next(ri(i,n.renderLocation,a)).next(qe());e(n,h,r,o,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/re,a=d.zManipulator.height*e,i=d.zManipulator.coneHeight*e,n=d.zManipulator.coneWidth*e,s=d.zManipulator.width*e,r=[N(0,0,0),N(0,0,a)],o=V.createTubeGeometry(r,s/2,16,!1),l=V.createConeGeometry(i,n/2,16,!1),h=[N(0,0,0),N(0,0,a+i)],p=M=>{const R=Tt();if(Ki(R,R,[0,0,a]),en(R,R,Math.PI/2),M){const U=1+2*M/n;oi(R,R,[U,U,U])}return R},g=p(0),u=(M,R)=>{const U=Jn(d.zManipulator.color,R);return[U.r/255,U.g/255,U.b/255,d.zManipulator.color.a*M]},v=pe(u(1,.25),X.Occlude),f=pe(u(1,0),X.Occlude),w=pe(u(.7,0),d.zManipulator.renderOccluded),A=pe(u(.85,0),d.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:g,material:v,stateMask:S.Unfocused},{geometry:o,material:v,stateMask:S.Unfocused},{geometry:l,transform:g,material:f,stateMask:S.Focused},{geometry:o,material:f,stateMask:S.Focused},{geometry:l,transform:g,material:w,stateMask:S.Unfocused},{geometry:o,material:w,stateMask:S.Unfocused},{geometry:l,transform:g,material:A,stateMask:S.Focused},{geometry:o,material:A,stateMask:S.Focused}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[h]}}_createManipulator(){const e=new j({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=a=>{const i=this._view.state.camera,n=ka;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,n);const s=Ji(i.eye,n),r=i.computeRenderPixelSizeAtDist(s),o=P(Ne,n,i.eye);ot(o,o);const l=Ls;this._view.renderCoordsHelper.worldUpAtPosition(ka,l);const h=Math.abs(Ot(o,l)),p=xe(Ne,o,l),g=xe(Ne,p,l),u=xt(h,.01,1),v=1-Math.sqrt(1-u*u)/u/i.fullWidth,f=this._radius/re,w=d.zManipulator.width*f;be(g,ot(g,g),(1/v-1)*s+r*w),a[12]-=Ne[0],a[13]-=Ne[1],a[14]-=Ne[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const ka=$(),Ne=$(),Ls=$();class Ie extends gt{constructor(e){super(),this._handles=new ie,this._angleDeferred=null,this._interactive=!0;const{tool:a,view:i,snapToScene:n,radius:s}=e;this._view=i,this.xyManipulation=new zs({tool:a,view:i,snapToScene:n,radius:s}),this.xyAxisManipulation=new Ps({tool:a,view:i,radius:s}),this.zManipulation=new Cs({tool:a,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(r=>{this._handles.add(r.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,a,i){return F([this.xyManipulation.createGraphicDragPipeline((n,s,r,o,l)=>e(K.XY,n,s,r,o,l),a,i),this.xyAxisManipulation.createGraphicDragPipeline((n,s,r,o,l)=>e(K.XY_AXIS,n,s,r,o,l),a,i),this.zManipulation.createGraphicDragPipeline((n,s,r,o,l)=>e(K.Z,n,s,r,o,l),a,i)])}createDragPipeline(e,a,i,n){return F([this.xyManipulation.createDragPipeline((s,r,o,l,h)=>e(K.XY,s,r,o,l,h),a,i,n),this.xyAxisManipulation.createDragPipeline((s,r,o,l,h)=>e(K.XY_AXIS,s,r,o,l,h),a,i,n),this.zManipulation.createDragPipeline((s,r,o,l,h)=>e(K.Z,s,r,o,l,h),i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(a=>e(a,O.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(a=>e(a,O.TRANSLATE_XY)),this.zManipulation.forEachManipulator(a=>e(a,O.TRANSLATE_Z))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator(a=>a.focused)||this.xyAxisManipulation.someManipulator(a=>a.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,a=this.xyManipulation;if(tn("esri-mobile"))return;const i=[];a.forEachManipulator(s=>i.push(s)),e.forEachManipulator(s=>i.push(s));const n=()=>{const s=[];this.xyAxisVisible?c(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator(r=>s.push(r.disableDisplay())),this._handles.remove(Fa),this._handles.add(s,Fa)};for(const s of i)this._handles.add(s.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",n)),n()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(a=>{a.interactive=!e&&this._interactive||a.grabbing})}static radiusForSymbol(e){const a=c(e)&&e.type==="point-3d"&&e.symbolLayers;return!!a&&a.length>0&&a.some(i=>i.type==="icon")?xi:re}}const Fa="disable-xy-axis-display";var K;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(K||(K={}));class sa extends gt{constructor(e){super(),this._handles=new ie,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(a=>this._tool.manipulators.add(a))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,O.TRANSLATE_XY)}createGraphicDragPipeline(e){return zt(this._graphicState,e,a=>this.createDragPipeline(a),this._view.state.viewingMode)}createDragPipeline(e){const a=this._view,i=this._graphicState.graphic,n=c(i.geometry)?i.geometry.spatialReference:null;return ae(this._manipulator,(s,r,o,l,h)=>{const p=r.next(an(h,a,i,n)).next(Fe()).next(qe());e(s,p,o,l,h)})}_createManipulator(){const e=this._view,a=this._graphicState.graphic;this._manipulator=new Kn({graphic:a,view:e,selectable:!0,cursor:"move"})}}class Hs{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class Ns{constructor(e,a,i){this.dx=e,this.dy=a,this.allGraphics=i,this.type="graphic-move"}}class Ua{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let ve=class extends li(we.EventedMixin($t)){constructor(t){super(t),this.graphics=new nn,this.enableZ=!0,this.type="move-3d",this._toolHandles=new ie,this.snappingPipeline=new At}initialize(){this._toolHandles.add([this.graphics.on("change",()=>this._refreshManipulators())]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>sn(e)===hi.SUPPORTED).map(e=>new ks(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const a=e.state;e.manipulationXY=new sa({tool:this,view:this.view,graphicState:a}),e.manipulationXY.forEachManipulator(i=>this.handles.add(i.events.on("immediate-click",n=>{this.emit("immediate-click",D(G({},n),{graphic:a.graphic})),n.stopPropagation()}))),this.handles.add(e.manipulationXY.createDragPipeline((i,n,s,r)=>this._buildDragEventPipeline(t,K.XY,i,n,s,r)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Ie({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?Ie.radiusForSymbol(t[0].graphic.symbol):re});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(n=>{this.handles.add(n.events.on("immediate-click",s=>{e.zManipulation.hasManipulator(n)||this.graphics.length!==1||this.emit("immediate-click",D(G({},s),{graphic:this.graphics.getItemAt(0)})),s.stopPropagation()}))});const a=()=>this._updateMoveManipulation(t);for(const n of t)this.handles.add([n.state.on("changed",a),n.state.watch("displaying",a)]);const i=t[t.length-1];this.handles.add(i.state.on("changed",()=>this._updateMoveManipulationAngle(i))),this.handles.add(e.createDragPipeline((n,s,r,o,l)=>this._buildDragEventPipeline(t,n,s,r,o,l),L(i.graphic),E(i.graphic.geometry).spatialReference,i.graphic)),this._updateMoveManipulationAngle(i)}_createVisualElements(t){for(const e of t){const a=e.graphic,i=Vt({view:this.view,graphic:a,forEachManipulator:n=>{e.manipulationXY.forEachManipulator(n),this._moveManipulation.forEachManipulator(n)},onManipulatorsChanged:()=>Ze()});y(i)||(e.geometryRepresentation=i.visualElement,e.geometryRepresentation instanceof Ve&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),e.state.watch("isDraped",()=>this._updateMoveManipulation(t))]),this.handles.add(i))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>Ei(t.graphic.geometry)}_updateMoveManipulation(t){const e=It(0,0,0,this.view.spatialReference);let a=0,i=!1;const n=this._moveManipulation;for(const s of t){if(!s.state.displaying)continue;const r=s.state.graphic;this.enableZ&&$e(r)&&(i=!0);const o=s.geometryRepresentation instanceof Ve&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:Zt(this.view,r);c(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,a++)}a>0?(e.x/=a,e.y/=a,e.z/=a,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=i):n.available=!1}_buildDragEventPipeline(t,e,a,i,n,s){const r=[],o=[];let l=null,h=null;const p=()=>{for(const u of r)u.dragging=!1;r.length=0,o.length=0,l=null,h=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===K.XY){const u=t[0].graphic;i=this._buildSnappingPipelineSteps(u,L(u),i,n,s)}const g=i.next(u=>{if(u.action==="start"){r.length=0,o.length=0;for(const v of t)v.dragging||!v.manipulationXY.hasManipulator(a)&&v.manipulationXY.grabbing||(r.push(v),o.push(v.graphic),v.dragging=!0);if(o.length!==0&&(this._moveManipulation.interactive=!1,l=rn(o,this.view.state.viewingMode),h=on(o),this.emit("graphic-move-start",new Hs(o)),this.destroyed))return null}return o.length!==0?u:null}).next(u=>l(u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const v=this.view.toScreen(u.mapStart),f=this.view.toScreen(u.mapEnd),w=f.x-v.x,A=f.y-v.y;if(this.emit("graphic-move",new Ns(w,A,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Ua(o)),this.destroyed)return null;p()}});return n.next(u=>h(u)).next(()=>{if(this.emit("graphic-move-stop",new Ua(o)),this.destroyed)return null;p()}),g}_buildSnappingPipelineSteps(t,e,a,i,n){const s=t.geometry;if(y(s)||s.type!=="point"&&s.type!=="mesh")return a;const r=(s.type==="point"?s:s.anchor).clone(),o=new Gt({elevationInfo:e,pointer:n,editGeometryOperations:Pt.fromGeometry(r,this.view.state.viewingMode),visualizer:new dt,excludeFeature:t}),l=this.snappingManager;return a.next(h=>(r.z=ln(this.view,r,L(t),{mode:"absolute-height",offset:0}),D(G({},h),{snapOrigin:o.coordinateHelper.pointToVector(r)}))).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:i,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};m([_({constructOnly:!0,nonNullable:!0})],ve.prototype,"view",void 0),m([_({readOnly:!0})],ve.prototype,"graphics",void 0),m([_({constructOnly:!0,nonNullable:!0})],ve.prototype,"enableZ",void 0),m([_({constructOnly:!0})],ve.prototype,"snappingManager",void 0),m([_({readOnly:!0})],ve.prototype,"type",void 0),m([_({readOnly:!0})],ve.prototype,"updating",null),ve=m([Ee("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],ve);class ks{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new ze({graphic:e})}get graphic(){return this.state.graphic}}function Ba(t,e,a){const i=a.mode==="on-the-ground"?Ga.XY:Ga.XYZ;return new es(t,i,e,0)}function Za(t,e,a){const i=$();if(!t.renderCoordsHelper.toRenderCoords(e,i))return null;const n=Ya(t,e,ut(a.plane)),s=Ya(t,e,a.edgeDirection);if(y(n)||y(s))return null;const r=xe($(),n,s);return pi(i,r,ea())}function Ya(t,e,a){const i=It(e.x+a[0],e.y+a[1],e.z+a[2],e.spatialReference),n=$(),s=$();return t.renderCoordsHelper.toRenderCoords(e,n)&&t.renderCoordsHelper.toRenderCoords(i,s)?ci(s,n,s):null}function Fs(t,e,a){const i=ut(t),n=ci($(),e,a),s=xe($(),n,i),r=xe($(),n,s);return hn(n[0],n[1],n[2],0,s[0],s[1],s[2],0,r[0],r[1],r[2],0,0,0,0,1)}function Us(t,e,a){const i=a.projectToRenderScreen(t,ga()),n=a.projectToRenderScreen(e,ga());return c(i)&&c(n)?cn(P(i,i,n)):0}let Re=class extends we.EventedMixin(ta){constructor(t){super(t),this._vertexManipulatorMaterial=pe(d.colorToVec4(d.reshapeManipulators.vertex.color),d.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=et(d.colorToVec4(d.reshapeManipulators.vertex.outlineColor),d.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=et(d.colorToVec4(d.reshapeManipulators.vertex.hoverOutlineColor),d.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=pe(d.colorToVec4(d.reshapeManipulators.edge.color),d.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=et(d.colorToVec4(d.reshapeManipulators.edge.outlineColor),d.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=pe(d.colorToVec4(d.reshapeManipulators.edgeOffset.color),d.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=pe(d.colorToVec4(d.reshapeManipulators.edgeOffset.hoverColor),d.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=pe(d.colorToVec4(d.reshapeManipulators.selected.color),d.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=et(d.colorToVec4(d.reshapeManipulators.selected.outlineColor),d.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=et(d.colorToVec4(d.reshapeManipulators.selected.hoverOutlineColor),d.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new ie,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=T.NONE,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new At,this._snappingPipelineHandle=new At,this._vertexLaserLineVisualElement=null}initialize(){const t=new ze({graphic:this.graphic});this._graphicState=t,this.handles.add([t.watch("displaying",e=>{for(const a of this._manipulatorInfos)a.manipulator.available=e}),this.view.trackGraphicState(t)])}destroy(){this._editGeometryOperations=C(this._editGeometryOperations),this._moveManipulation=C(this._moveManipulation),this._graphicMoveManipulation=C(this._graphicMoveManipulation),this._manipulatorHandles=C(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.handle.type==="vertex");this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=C(this._moveManipulation),this._graphicMoveManipulation=C(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(y(this._editGeometryOperations))return;const t=L(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const a of e.vertices)this._createVertexOrEdgeManipulator(a,t);for(const a of e.edges)this._createVertexOrEdgeManipulator(a,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(y(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(y(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),y(t)||(C(this._editGeometryOperations),this._editGeometryOperations=Pt.fromGeometry(t,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return;let a=0;const i=[],n=this._manipulatorInfos.some(r=>r.handle.type==="vertex"&&r.manipulator.selected),s=t===Be.SELECTED_OR_ALL&&n;for(const r of this._manipulatorInfos)tt(r)&&(r.manipulator.grabbing||s&&!r.manipulator.selected||i.push(r),a++);if(i.length!==0)if(this._moveVertices(i,e),i.length===a){if(this._updateEventState(T.MOVING),this.destroyed)return;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(T.RESHAPING),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)tt(e)&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(T.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:a,mapDeltaZ:i}=t;if(!e&&!a&&!i)return;const n=[];for(const s of this._manipulatorInfos)tt(s)&&(s.manipulator.selected&&!s.manipulator.grabbing||s===t.info)&&n.push(s);this._moveVertices(n,t,ce.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case T.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case T.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case T.MOVING:switch(this._reshapeEventState){case T.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case T.RESHAPING:switch(this._reshapeEventState){case T.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case T.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){if(this._graphicMoveManipulation=new sa({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let i=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((n,s,r)=>{s.next(o=>this._trackNumDragging(o)).next(o=>(o.action==="start"&&(i=E(this._editGeometryOperations).createUndoGroup()),o)).next(o=>{this._perGraphicManipulatorDragAction(Be.ALL,o),o.action==="end"&&(i=Ge(i))}),r.next(this._cancelDragOperation(()=>i=Ge(i)))}))}else this._graphicMoveManipulation.forEachManipulator(i=>{i.grabbable=!1,i.cursor=null});this._graphicMoveManipulation.forEachManipulator(i=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(i,!1),i.events.on("immediate-click",n=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",D(G({},n),{graphic:this.graphic})),n.stopPropagation()})])),this._moveManipulation=new Ie({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&$e(this.graphic),snapToScene:!1,radius:Ie.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator(i=>{this.handles.add([this._watchAndUpdateGrabState(i,!1),i.events.on("immediate-click",n=>{this._moveManipulation.zManipulation.hasManipulator(i)||this._manipulatorInfos.some(s=>s.manipulator.selected)||this.emit("immediate-click",D(G({},n),{graphic:this.graphic})),n.stopPropagation()})])}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const e=E(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline((i,n,s,r,o)=>{const l=s.next(h=>this._trackNumDragging(h)).next(h=>{const p=this._manipulatorInfos.filter(g=>tt(g)&&g.manipulator.selected);return h.manipulatorType===O.TRANSLATE_XY&&p.length===1?D(G({},h),{info:p[0],snapOrigin:p[0].handle.pos}):D(G({},h),{info:null})}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:h=>!!h.info,cancel:r,snappingManager:this.tool.snappingManager,snappingContext:new Gt({editGeometryOperations:E(this._editGeometryOperations),elevationInfo:t,pointer:o,excludeFeature:this.graphic,visualizer:new dt}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Fe()).next(h=>(this._perGraphicManipulatorDragAction(Be.SELECTED_OR_ALL,h),h));return r.next(this._cancelDragOperation()),l},t,e,this.graphic),Pe(this._graphicState,"displaying",()=>{this._updateMoveManipulationPosition()}),this._graphicState.on("changed",()=>this._updateMoveManipulationPosition()),Pe(this._graphicState,"isDraped",()=>{const i="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),i):this.handles.remove(i)})]),this._updateMoveManipulationPosition();const a=Vt({view:this.view,graphic:this.graphic,forEachManipulator:i=>{if(!this.destroyed){c(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(i);for(const n of this._manipulatorInfos)i(n.manipulator,O.TRANSLATE_XY);this._moveManipulation.forEachManipulator(i)}},onManipulatorsChanged:i=>this.on("manipulators-changed",i)});c(a)&&(this._outlineVisualElement=a.visualElement instanceof Ve?a.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}),this._graphicState.watch("isDraped",()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(a)}_createEdgeOffsetManipulator(t,e=L(this.graphic)){const a=d.reshapeManipulators.edgeOffset,i=a.size/2,n=i+a.collisionPadding;if(y(this._edgeOffsetManipulatorGeometryInside)||y(this._edgeOffsetManipulatorGeometryOutside)){const u=i/n,v=u*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=V.createExtrudedTriangle(v,u/2,u/2,a.height,a.offset),this._edgeOffsetManipulatorGeometryOutside=V.createExtrudedTriangle(-v,u/2,u/2,a.height,-a.offset)}const s=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:S.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:S.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:S.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:S.Focused}],r=new j({view:this.view,renderObjects:s,elevationInfo:e.mode!=="on-the-ground"||ma(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:N(0,0,1)},collisionPriority:1}),o=new j({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:r,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const h=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),p=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=F([h,p]),this._manipulatorHandles.add(l.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(o,!0)],r),this._manipulatorHandles.add(ae(r,this._createEdgeOffsetPipeline(l,e)),r),this._manipulatorHandles.add(ae(o,(u,v,f,w)=>{if(w==="touch")this._createEdgeOffsetPipeline(l,e)(u,v,f);else if(this.enableMoveGraphic){const A=this.graphic,M=c(A.geometry)?A.geometry.spatialReference:null;v.next(R=>this._trackNumDragging(R)).next(rt(this.view,u.elevationAlignedLocation)).next(Jt(this.view,u.elevationAlignedLocation,e,M,A)).next(qe()).next(Fe()).next(R=>this._perGraphicManipulatorDragAction(Be.ALL,R)),f.next(this._cancelDragOperation())}}),r);const g=u=>{this._manipulatorInfos.some(v=>v.manipulator.selected)?this._clearSelection():this.emit("immediate-click",D(G({},u),{graphic:this.graphic})),u.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",g),o.events.on("immediate-click",g)],r),this._manipulatorInfos.push(l),this.manipulators.add(r),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const a=t.manipulator,i=t.edgeManipulator,n=()=>{Ge(t.visibilityHandle);const s=Us(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!a.focused&&!i.focused||s)&&(a.grabbable=!s,i.grabbable=!s,t.visibilityHandle=F([a.disableDisplay(),{remove:()=>{a.grabbable=!0,i.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",n),i.events.on("focus-changed",n),{remove:()=>{Ge(t.visibilityHandle),this.manipulators.remove(i)}}],a),n()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=E(this._editGeometryOperations).data.coordinateHelper,a=Za(this.view,t.manipulator.elevationAlignedLocation,Ba(e,t.handle,E(t.manipulator.elevationInfo))),i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,n=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,s=c(a)?Fs(a,i,n):pn;t.manipulator.modelTransform=s,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=s;const r=Ye(P(ft,i,n))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-r,0,0],[r,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(a,i,n)=>{this._clearSelection();const{step:s,cleanup:r}=this._initializeEdgeOffset(t,e);i.next(o=>this._trackNumDragging(o)).next(rt(this.view,a.elevationAlignedLocation)).next(s).next(dn(this.view)).next(un(this.view,E(this._editGeometryOperations).data.spatialReference)).next(Fe()).next(this._applyEdgeOffsetStep(t)).next(o=>{o.action==="end"&&r()}),n.next(o=>(r(),o)).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const a=E(this._editGeometryOperations),i=Ba(a.data.coordinateHelper,t.handle,e),n=a.createUndoGroup(),s=Za(this.view,t.manipulator.elevationAlignedLocation,i);i.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),i.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const r=()=>new gn({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:E(this._editGeometryOperations).data.spatialReference}),o=new Ve({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:t.elevationInfo,width:d.visualElements.lineGraphics.outline.width,color:d.colorToVec4(ia.main),attached:!0});let l;const h=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=Ge(l)},p=this.on("undo",h);return l=F([Y(o),this._graphicState.watch("isDraped",g=>o.isDraped=g),this._graphicState.on("changed",()=>o.geometry=r()),n,p]),{step:g=>y(i)||y(s)?(h(),null):D(G({},g),{operation:i,plane:s}),cleanup:h}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||y(e.operation))return e;this._updateEventState(T.RESHAPING);const{mapDeltaX:a,mapDeltaY:i,mapDeltaZ:n}=e;return(a||i||n)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_cleanEdgeOffsetCollapsedEdges(t){var e,a;const i=(e=t.handle.leftVertex.leftEdge)==null?void 0:e.leftVertex,n=t.handle.leftVertex,s=(a=t.handle.rightVertex.rightEdge)==null?void 0:a.rightVertex,r=t.handle.rightVertex,o=E(this._editGeometryOperations).data.coordinateHelper,l=1e-6,h=[];i&&o.distance(i.pos,n.pos)<l&&h.push(this._getManipulatorInfoFromHandle(n)),(o.distance(n.pos,r.pos)<l||s&&o.distance(s.pos,r.pos)<l)&&h.push(this._getManipulatorInfoFromHandle(r)),h.length&&this._removeVertices(h)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,a=e+t.collisionPadding;return{size:e/a,outlineSize:(e+t.outlineSize)/a}}_createVertexOrEdgeManipulator(t,e=L(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(y(this._vertexManipulatorGeometry)||y(this._vertexManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(d.reshapeManipulators.vertex);this._vertexManipulatorGeometry=V.createSphereGeometry(r,16,16),this._vertexManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}if(y(this._edgeManipulatorGeometry)||y(this._edgeManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(d.reshapeManipulators.edge);this._edgeManipulatorGeometry=V.createSphereGeometry(r,16,16),this._edgeManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}const a=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Q.Vertex|S.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:Q.Vertex|S.Unfocused|S.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Q.Vertex|S.Focused|S.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:S.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:S.Selected|S.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:S.Selected|S.Focused}];this.enableMidpoints&&a.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Q.Edge|S.Focused|S.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Q.Edge|S.Focused|S.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:Q.Edge|S.Unfocused|S.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:Q.Edge|S.Unfocused|S.Unselected});const i=new j({view:this.view,renderObjects:a,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(i,t,e);const n=t.type==="edge"?{manipulator:i,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:i,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(n),this.manipulators.add(i),this._updateManipulatorPosition(n),n.type==="edge"){const r=this._getManipulatorInfoFromHandle(n.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(n)),o=this._getManipulatorInfoFromHandle(n.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(n));n.locationUpdateHandle=F([r,o]),this._manipulatorHandles.add(n.locationUpdateHandle,i)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(i,!0),i);const s=ae(i,(r,o,l,h)=>{let p=null;o.next(g=>this._trackNumDragging(g)).next(g=>{if(g.action==="start"&&(p=E(this._editGeometryOperations).createUndoGroup()),ja(n)){const u=this._splitEdgeManipulator(n);return D(G({},g),{info:u,snapOrigin:u.handle.pos})}return D(G({},g),{info:n,snapOrigin:n.handle.pos})}).next(rt(this.view,r.elevationAlignedLocation)).next(mn(this.view,this.graphic,r.elevationAlignedLocation,r.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new Gt({editGeometryOperations:E(this._editGeometryOperations),elevationInfo:e,pointer:h,excludeFeature:this.graphic,visualizer:new dt}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Fe()).next(g=>{this._perVertexManipulatorDragAction(g),g.action==="end"&&(p=Ge(p))}),l.next(this._cancelDragOperation(()=>p=Ge(p)))});return this._manipulatorHandles.add(s,i),this._manipulatorHandles.add([i.events.on("immediate-click",r=>this._manipulatorClickCallback(r,n)),i.events.on("select-changed",()=>{n.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})],i),this.emit("manipulators-changed"),n}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case T.NONE:break;case T.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(T.NONE)}}_setTypeSpecificManipulatorSettings(t,e,a){switch(e.type){case"vertex":t.state=Q.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=d.reshapeManipulators.vertex.size/2+d.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=a,t.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=Q.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=d.reshapeManipulators.edge.size/2+d.reshapeManipulators.edge.collisionPadding,t.elevationInfo=a.mode!=="on-the-ground"||ma(this.graphic.symbol)?{mode:"absolute-height",offset:0}:a}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",a=>{if(a.action==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(T.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a.pointerType!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(i=>{i.manipulator.interactive=!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in i&&(i.edgeManipulator.interactive=!this._numGrabbing)}),E(this._graphicMoveManipulation).forEachManipulator(i=>i.interactive=!this._numGrabbing))})}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(!t)return;const e=E(this._editGeometryOperations);if(t.handle.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,at),t.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.handle.type==="edge"){const a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,i=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(c(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const n=a.location,s=i.location,r=.5,o=n.x+r*(s.x-n.x),l=n.y+r*(s.y-n.y),h=n.hasZ&&s.hasZ?0:void 0;t.manipulator.location=It(o,l,h,e.data.spatialReference)}else Se(ft,a.renderLocation,i.renderLocation,.5),t.manipulator.renderLocation=ft}}_splitEdgeManipulator(t,e=.5){const a=E(this._editGeometryOperations),i=E(a.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const n=L(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(t),s=this._createVertexOrEdgeManipulator(i)):(s=t,s.handle=i,s.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,n)),i.leftEdge&&this._createVertexOrEdgeManipulator(i.leftEdge),i.rightEdge&&this._createVertexOrEdgeManipulator(i.rightEdge),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(s),this._updateSelection(t.manipulator);const r=this._updateEventState(T.RESHAPING),o=a.data.coordinateHelper.vectorToArray(s.handle.pos),l=a.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:E(i.index)}],added:o}),r&&this._updateEventState(T.NONE),s}_updateMoveManipulationPosition(){const t=te(ft,0,0,0);let e=0,a=!1,i=null,n=null;for(const s of this._manipulatorInfos)tt(s)&&(s.manipulator.selected?(e++,de(t,t,s.manipulator.renderLocation),y(i)||s.selectedIndex>i.selectedIndex?(n=i,i=s):(y(n)||s.selectedIndex>n.selectedIndex)&&(n=s)):a=!0);if(e!==0){const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&$e(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&e!==1}else{const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&$e(this.graphic)}if(e!==0){let s=0;if(c(i)){const r=i.handle.pos,o=c(n)?n.handle.pos:i.handle.leftEdge&&i.handle.leftEdge.leftVertex?i.handle.leftEdge.leftVertex.pos:null,l=!c(n)&&i.handle.rightEdge&&i.handle.rightEdge.rightVertex?i.handle.rightEdge.rightVertex.pos:null;o&&l?this._moveManipulation.xyAxisManipulation.available=!1:o?s=Xa(o,r):l&&(s=Xa(r,l))}this._moveManipulation.angle=s,this._moveManipulation.radius=xi}else this._moveManipulation.angleDeferred=()=>Ei(E(this.graphic.geometry)),this._moveManipulation.radius=Ie.radiusForSymbol(this.graphic.symbol);e!==0&&a?(be(t,t,1/e),at.spatialReference=E(this._editGeometryOperations).data.spatialReference,at.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,at),this._moveManipulation.elevationAlignedLocation=at):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:di(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],a=E(this._editGeometryOperations);for(const i of t)if(i.handle.type==="vertex"&&a.canRemoveVertex()){e.push(i.handle),this._removeManipulator(i),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(i.handle.rightEdge));const n=E(a.removeVertices([i.handle]).removedVertices[0].createdEdge);n&&this._createVertexOrEdgeManipulator(n)}if(e.length>0){const i=e.map(s=>{const r=a.data.components.indexOf(s.component);return{coordinates:a.data.coordinateHelper.vectorToArray(s.pos),componentIndex:r,vertexIndex:E(s.index)}});this.outputGeometry=a.data.geometry;const n=this._updateEventState(T.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:i.map(s=>s.coordinates),vertices:i}),this.destroyed)||n&&(this._updateEventState(T.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,a=e.action==="start"?ce.NEW_STEP:ce.ACCUMULATE_STEPS){const i=E(this._editGeometryOperations);i.moveVertices(t.map(n=>n.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a),this.outputGeometry=i.data.geometry;for(const n of t)this._updateManipulatorPosition(n)}_offsetEdge(t,e){if(y(e.operation))return;const a=E(this._editGeometryOperations),i=e.operation.clone();i.distance=e.operation.signedDistanceToPoint(e.mapEnd),a.updateVertices([t.handle.leftVertex,t.handle.rightVertex],i),this.outputGeometry=a.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.handle.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected),e.handle.type==="vertex"&&t.button===_a.Right&&this._removeVertices([e]),ja(e)&&t.button===_a.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}};function Xa(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function tt(t){return t.handle.type==="vertex"}function ja(t){return t.handle.type==="edge"}m([_({constructOnly:!0})],Re.prototype,"tool",void 0),m([_()],Re.prototype,"inputGeometry",null),m([_()],Re.prototype,"outputGeometry",void 0),m([_({readOnly:!0})],Re.prototype,"updating",null),Re=m([Ee("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Re);const at=It(0,0,null,null),ft=$();var Q,T,Be;(function(t){t.Vertex=he.Custom1,t.Edge=he.Custom2})(Q||(Q={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(T||(T={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Be||(Be={}));let k=class extends we.EventedMixin($t){constructor(t){super(t),this._handles=new ie,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=C(this._handles),this._reshapeOperation=C(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.updating)!=null&&t}_updateGeometry(){const t=_n(this.graphic);this._reshapeOperation.inputGeometry=c(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),vn(this.graphic)!==hi.SUPPORTED)return;const t=this.watch("graphic.geometry",()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},!0);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){y(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new Re({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),this._reshapeOperation.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),this._reshapeOperation.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),this._reshapeOperation.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),this._reshapeOperation.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>{t.stopPropagation()}),Pe(this,"graphic",()=>{this._updateGraphic()},!0)]),this.finishToolCreation()}get canUndo(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.canUndo)!=null&&t}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.canRedo)!=null&&t}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};m([_()],k.prototype,"_reshapeOperation",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"view",void 0),m([_({constructOnly:!0})],k.prototype,"graphic",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"enableZShape",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"enableZVertex",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"enableMoveGraphic",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"enableMidpoints",void 0),m([_({constructOnly:!0,nonNullable:!0})],k.prototype,"enableEdgeOffset",void 0),m([_({readOnly:!0})],k.prototype,"type",void 0),m([_({constructOnly:!0})],k.prototype,"snappingManager",void 0),m([_({readOnly:!0})],k.prototype,"updating",null),m([_()],k.prototype,"automaticManipulatorSelection",void 0),k=m([Ee("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],k);var x,Xe;(function(t){t.ScaleIn=he.Custom2,t.ScaleOut=he.Custom3,t.RotateLeft=he.Custom4,t.RotateRight=he.Custom5,t.Unlocked=he.Custom7,t.DelayedFocused=he.Custom8,t.TouchInput=he.Custom12})(x||(x={}));class Bs{constructor(e){this.mode=null,this._handles=new ie,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new we,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=C(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const a=yn({update:({deltaTime:i})=>{e.update(i)&&this.cancelActiveAnimation()}});this._activeAnimation=D(G({},e),{frameTask:a})}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=C(this._activeAnimation))}forEachManipulator(e){e(this.ringManipulator,O.SCALE_ROTATE)}_createManipulator(){this.ringManipulator=this._createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,a=this.tool.graphicState.graphic,i=ae(e,(n,s,r)=>{this._scaleRotateDragData=null,this.adapter.restart();const o={mode:"none",origin:ui(n.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=o,this._updateDragState();const l=b.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(n.renderLocation,l),s.next(Yt(this.tool.view,pi(n.renderLocation,l,ea()))).next(h=>{const p=ut(h.plane),g=gi(h.renderStart,h.renderEnd,o.origin,p),u=fn.shortestSignedDiff(o.angle,g);o.angleDir=xt(o.angleDir+u,-Na,Na),o.angle=g;const v=Zs(o,h),f=v-this.adapter.scale;if(o.scaleDir=xt(o.scaleDir+f,-Ha,Ha),this._onScaleChanged(),o.mode==="none"){const w=this.mode||Ys(h,h.plane,o.origin,this.tool.view.state.camera);if(c(w)){switch(w){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:a,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}o.mode=w}}switch(o.mode){case"rotate":this.adapter.angle=o.initialAngle+g;break;case"scale":this.adapter.scale=v,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),h.action){case"start":case"update":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:a,angle:pt(o.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:a,xScale:v,yScale:v})}break;case"end":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:pt(o.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:v,yScale:v})}}h.action==="end"&&(this.startAnimation(qa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState())}),r.next(()=>{if(this.adapter.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1})}this.startAnimation(qa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}})});this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",n=>{n.action==="focus"?this.startAnimation(Xs(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",n=>{n.stopPropagation()}),Pe(this.tool.graphicState,"displaying",n=>this.ringManipulator.available=n)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(x.DelayedFocused,this.getFocused())}_updateDragState(){if(this.ringManipulator.updateStateEnabled(x.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(x.ScaleIn|x.ScaleOut,!1),this.ringManipulator.updateStateEnabled(x.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(x.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(x.RotateLeft|x.RotateRight,!1),this.ringManipulator.updateStateEnabled(x.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(x.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(x.ScaleIn|x.ScaleOut|x.RotateLeft|x.RotateRight,!1)}_updateManipulatorTransform(){const e=ni(Z.get(),this.adapter.angle,N(0,0,1)),a=this.getScale(),i=wt(Z.get(),te(b.get(),a,a,a));this.ringManipulator.modelTransform=bt(Z.get(),i,e)}_createRingManipulator(){const e=(I,ne,ue)=>{const ge=[],me=Math.ceil(Si*(ne-I)/(2*Math.PI));for(let H=0;H<me+1;H++){const Je=I+H*(ne-I)/me;ge.push(N(ue*Math.cos(Je),ue*Math.sin(Je),0))}return ge},a=I=>e(0,2*Math.PI,I),i=I=>[[-I/2,0],[I/2,0],[I/2,Ht/2],[-I/2,Ht/2]],n=(I,ne)=>V.createPathExtrusionGeometry(i(ne),I,[],[],!1),s=a(De),r=n(s,Nt),o={left:[],right:[]},l=[];for(let I=0;I<2;I++){const ne=I*Math.PI-Math.PI/4,ue=Math.PI/2-Rs,ge=ne+ue,me=ne+Math.PI/2-ue,H=e(ge,me,Os),Je=n(H,He);l.push(H),l.push(e(ge,me,Pa-Nt/2)),o.left.push(Je),o.right.push(Je);for(let Ct=0;Ct<2;Ct++){const ra=Ct===0,B=Tt();if(ra){oi(B,B,[1,-1,1]),va(B,B,-ge,[0,0,1]);const Oe=Math.round(za*(H.length-1));B[12]=H[Oe][0],B[13]=H[Oe][1],B[14]=H[Oe][2]}else{va(B,B,me,[0,0,1]);const Oe=Math.round((1-za)*(H.length-1));B[12]=H[Oe][0],B[13]=H[Oe][1],B[14]=H[Oe][2]}const oa=V.createExtrudedTriangle(Gs,0,As,Ht);V.transformInPlace(oa,B),(ra?o.left:o.right).push(oa)}}const h=[];for(let I=0;I<2;I++){const ne=I*Math.PI-Math.PI/4,ue=Math.PI/2-Ds,ge=ne+ue,me=ne+Math.PI/2-ue,H=e(ge,me,Pa);h.push(n(H,He))}const p=a(De+Ca),g=a(De+La),u=n(p,He),v=n(g,He),f=a(De-Ca),w=a(De-La),A=n(f,He),M=n(w,He),R=this._createMaterial(),U=this._createMaterial(.66),We=this._createMaterial(.5),Qe=this._createMaterial(.33);let oe=[{geometry:r,material:R,stateMask:x.DelayedFocused},{geometry:r,material:We,stateMask:S.None}];this.mode&&this.mode!=="scale"||(oe=oe.concat([{geometry:h,material:R,stateMask:x.DelayedFocused|x.Unlocked},{geometry:u,material:U,stateMask:x.DelayedFocused|x.ScaleIn},{geometry:v,material:Qe,stateMask:x.DelayedFocused|x.ScaleIn},{geometry:A,material:U,stateMask:x.DelayedFocused|x.ScaleOut},{geometry:M,material:Qe,stateMask:x.DelayedFocused|x.ScaleOut}])),this.mode&&this.mode!=="rotate"||(oe=oe.concat([{geometry:o.right,material:R,stateMask:x.DelayedFocused|x.Unlocked},{geometry:o.left,material:R,stateMask:x.DelayedFocused|x.RotateLeft},{geometry:o.right,material:R,stateMask:x.DelayedFocused|x.RotateRight}]));const mt=[s,...l];return new j({view:this.tool.view,renderObjects:oe,autoScaleRenderObjects:!1,worldOriented:!0,radius:Nt,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:L(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:mt,direction:N(0,0,1)}})}_createMaterial(e=1){const a=[...bs,e];return new Kt({color:a,transparent:e!==1,cullFace:ct.Back,renderOccluded:X.Transparent})}get test(){return{ringManipulator:this.ringManipulator}}}function Zs(t,e){const a=P(b.get(),e.renderStart,t.origin),i=P(b.get(),e.renderEnd,t.origin),n=Ye(a),s=Ye(i);return n===0?0:s/n}function Ys(t,e,a,i){const{renderStart:n,renderEnd:s}=t,r=Mt(n,i,b.get()),o=Mt(s,i,b.get());if(Mn(r,o)<Va*Va)return null;const l=P(b.get(),n,a),h=xe(b.get(),l,ut(e)),p=n,g=de(b.get(),p,h),u=Mt(a,i,b.get()),v=r,f=Mt(g,i,b.get()),w=P(b.get(),f,v),A=P(b.get(),r,u),M=ya(v,w),R=ya(u,A);return fa(M,o)<fa(R,o)?"rotate":"scale"}function Mt(t,e,a){return e.projectToScreen(t,kt),te(a,kt[0],kt[1],0)}function qa(t,e){let a=null,i=1;const n=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=n,e()},update:s=>(i+=((i+1)/2-i)*Math.min(s*$s,1),e(),Math.abs(i-1)<.01?Xe.STOP:Xe.CONTINUE),destroy:()=>{t.getScale=a,e()}}}function Xs(t,e){let a=0,i=null;const n=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=n,a=0,e()},update:s=>(a+=s,!i()||a>Ts?Xe.STOP:Xe.CONTINUE),destroy:()=>{t.getFocused=i,e()}}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(Xe||(Xe={}));const kt=je();function wi(t){return c(t.geometry)&&t.geometry.type==="mesh"?js(t.geometry):qs(t)}function js(t){return c(t.transform)?Ws(t,t.transform):Qs(t)}function qs(t){let e=t.geometry,a=mi;return{undo(i){a=i.geometry,i.geometry=e},redo(i){e=i.geometry,i.geometry=a}}}function Ws(t,e){let a=e.clone(),i=null;return{undo:n=>{i=c(t.transform)?t.transform.clone():null,t.transform=a,n.notifyGeometryChanged()},redo:n=>{a=c(t.transform)?t.transform.clone():null,t.transform=i,n.notifyGeometryChanged()}}}function Qs(t){let e,a=t.vertexAttributes.clonePositional();return{undo:i=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=a,i.notifyGeometryChanged()},redo:i=>{a=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,i.notifyGeometryChanged()}}}let ye=class extends ta{constructor(t){super(t),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(Wa);const t=this.geometry.transform;if(this.scale=1,c(t)){const e=ss(t.rotation)[2];Math.abs(e)>.999999&&(this.angle=Dt(rs(t.rotation))*Math.sign(e))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add(_i(()=>({angle:this.angle,scale:this.scale}),e=>this._update(e),vi),Wa)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return wi(this.graphic)}_update({scale:t,angle:e}){const a=this.geometry.anchor,i=this.viewingMode===yi.Global;t!==this.previousScale&&(this.geometry.scale(t/this.previousScale,{origin:a,geographic:i}),this.previousScale=t,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()),e!==this.previousAngle&&(this.geometry.rotate(0,0,pt(e-this.previousAngle),{origin:a,geographic:i}),this.previousAngle=e,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged())}};m([_({constructOnly:!0})],ye.prototype,"graphic",void 0),m([_({constructOnly:!0})],ye.prototype,"geometry",void 0),m([_({constructOnly:!0})],ye.prototype,"viewingMode",void 0),m([_()],ye.prototype,"angle",void 0),m([_()],ye.prototype,"scale",void 0),ye=m([Ee("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],ye);const Wa="scale-heading-update-key";let le=class extends ta{constructor(t){super(t),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(Qa);const t=c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:mi;if(this.symbol=c(t)?t.clone():null,this.initialSizes=[],c(t)){const e=this.findLayerView();c(e)&&(this.initialSizes=t.symbolLayers.map(a=>a.type==="object"?e.getSymbolLayerSize(t,a):null).toArray())}this.angle=0,c(t)&&t.symbolLayers.some(e=>!(e.type!=="object"||!c(e.heading))&&(this.angle=-Dt(e.heading),!0)),this.initialAngle=this.angle,this.scale=1,this.handles.add(_i(()=>({angle:this.angle,scale:this.scale}),e=>this._updateSymbol(e),vi),Qa)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:a=>{e=a.symbol,a.symbol=t,this.restart()},redo:a=>{t=a.symbol,a.symbol=e,this.restart()}}}_updateSymbol({scale:t,angle:e}){const a=this.graphic.symbol;if(y(this.symbol)||y(a)||a.type!=="point-3d")return;const i=a.clone(),n=-pt(e-this.initialAngle);let s=!1;this._forEachObjectSymbolLayerPair(this.symbol,i,(r,o,l)=>{const h=Xt(r.heading,0)+n;o.heading!==h&&(o.heading=h,s=!0);const p=this.initialSizes[l];if(c(p)&&"width"in p){p.width=this.sizeFilter(p.width),p.height=this.sizeFilter(p.height),p.depth=this.sizeFilter(p.depth);const g=p.width*t;o.width!==g&&(o.width=g,s=!0);const u=p.depth*t;o.depth!==u&&(o.depth=u,s=!0);const v=p.height*t;o.height!==v&&(o.height=v,s=!0)}}),s&&(this.graphic.symbol=i)}_forEachObjectSymbolLayerPair(t,e,a){t.symbolLayers.forEach((i,n)=>{const s=e.symbolLayers.getItemAt(n);i.type==="object"&&s.type==="object"&&a(i,s,n)})}};m([_()],le.prototype,"angle",void 0),m([_()],le.prototype,"scale",void 0),m([_({constructOnly:!0})],le.prototype,"graphic",void 0),m([_()],le.prototype,"symbol",void 0),m([_({constructOnly:!0})],le.prototype,"findLayerView",void 0),m([_({constructOnly:!0})],le.prototype,"sizeFilter",void 0),le=m([Ee("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],le);const Qa="scale-heading-update-key";let q=class extends li(we.EventedMixin($t)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new At}initialize(){this.graphicState=new ze({graphic:this.graphic}),this.moveManipulation=new Ie({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&$e(this.graphic),radius:Ie.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator(e=>this.handles.add(e.events.on("immediate-click",a=>{this.emit("immediate-click",D(G({},a),{graphic:this.graphicState.graphic})),a.stopPropagation()}))),this.moveManipulation.elevationInfo=L(this.graphic);const t=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline((e,a,i,n,s)=>(c(t)&&e===K.XY&&(i=i.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new Gt({elevationInfo:L(this.graphic),pointer:s,editGeometryOperations:Pt.fromGeometry(new Sn({spatialReference:t.spatialReference}),this.view.state.viewingMode),visualizer:new dt,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:n}),this.snappingPipeline.next)),i),this.graphicState,e=>{const{action:a,graphic:i,dxScreen:n,dyScreen:s}=e,r={graphic:i,dxScreen:n,dyScreen:s};switch(a){case"start":this.emit("graphic-translate-start",r),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}}),this.moveManipulation.angle=c(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Bs({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([Vt({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>Ze()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),this.view.watch("scale",()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(e=>{e instanceof j&&this.handles.add(e.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}_updateManipulatorsInteractive(){y(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new ye({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new le({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer)})}_forEachManipulator(t){this.moveManipulation.forEachManipulator(t),c(this.scaleRotate)&&this.scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",t=>{this._forEachManipulator(e=>e.available=t),this.moveManipulation.zManipulation.available=t&&this.enableZ&&$e(this.graphic)})}_createGeometryUndoRecord(){return wi(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=C(this.scaleRotate),this.scaleRotateAdapter=C(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(t){this.moveManipulation&&(this.moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this.moveManipulation.location=t,c(this.scaleRotate)&&(this.scaleRotate.location=t)}set elevationAlignedLocation(t){this.moveManipulation.elevationAlignedLocation=t,c(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){c(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(y(this.scaleRotate))return;const t=this.scaleRotate.getScale();this.moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===yi.Local||this.view.scale<Is?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}_onGeometryChanged(){di(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};m([_({constructOnly:!0,nonNullable:!0})],q.prototype,"view",void 0),m([_({constructOnly:!0,nonNullable:!0})],q.prototype,"graphic",void 0),m([_({constructOnly:!0,nonNullable:!0})],q.prototype,"enableZ",void 0),m([_()],q.prototype,"enableRotation",void 0),m([_()],q.prototype,"enableScaling",void 0),m([_({value:!1})],q.prototype,"snapToScene",null),m([_({constructOnly:!0})],q.prototype,"snappingManager",void 0),m([_({readOnly:!0})],q.prototype,"type",void 0),m([_({readOnly:!0})],q.prototype,"updating",null),q=m([Ee("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],q);class Js{constructor(){this.lastDragEvent=null,this.next=new si,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const a=D(G({},this.lastDragEvent),{action:"update"});e&&this._adjustScaleFactors(a),this.next.execute(a)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent=e.action!=="end"?G({},e):null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const a=fi(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-a:a,e.factor2=e.factor2<0?-a:a}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function St(t,e){return Oi(t,e,!1)}function Ja(t,e){return Oi(t,e,!0)}function Oi(t,e,a){if(t instanceof ts){if(t.operation instanceof as)return Ks(t.operation,e,a),!0;if(t.operation instanceof is)return er(t.operation,e,a),!0;if(t.operation instanceof ns)return tr(t.operation,e,a),!0}return!1}function Ks(t,e,a=!1){const i=a?-1:1,n=N(i*t.dx,i*t.dy,i*t.dz);de(e.origin,e.origin,n)}function er(t,e,a=!1){const i=a?-t.angle:t.angle;Ma(e.basis1,e.basis1,Sa,i),Ma(e.basis2,e.basis2,Sa,i)}function tr(t,e,a=!1){const i=a?1/t.factor1:t.factor1,n=a?1/t.factor2:t.factor2;be(e.basis1,e.basis1,i),be(e.basis2,e.basis2,n),ba(e.origin,e.origin,t.origin,t.axis1,i),ba(e.origin,e.origin,t.origin,t.axis2,n)}function ar(t,e,a,i){i||(i=Ue());const n=fe(ke.get(),t[1],-t[0]),s=fe(ke.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=fe(ke.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=ke.get();e.components.forEach(p=>p.vertices.forEach(g=>{const u=g.pos;fe(o,xa(t,u),xa(n,u)),xn(s,s,o),En(r,r,o)}));const l=1e-6,h=fe(ke.get(),r[0]-s[0]<l?a/2:0,r[1]-s[1]<l?a/2:0);return Wt(s,s,h),Te(r,r,h),st(i.basis1,t,(r[0]-s[0])/2),st(i.basis2,n,(r[1]-s[1])/2),fe(i.origin,s[0]*t[0]+s[1]*n[0],s[0]*t[1]+s[1]*n[1]),Te(i.origin,i.origin,i.basis1),Te(i.origin,i.origin,i.basis2),i}function ir(t,e,a,i=0,n){n||(n=Ue()),e.toRenderCoords(t.origin,a,n.origin);const s=b.get();de(s,t.origin,t.basis1),de(s,s,t.basis2),e.toRenderCoords(s,a,s);const r=b.get();de(r,t.origin,t.basis1),P(r,r,t.basis2),e.toRenderCoords(r,a,r);const o=b.get();P(o,t.origin,t.basis1),P(o,o,t.basis2),e.toRenderCoords(o,a,o);const l=b.get();P(l,t.origin,t.basis1),de(l,l,t.basis2),e.toRenderCoords(l,a,l);const h=Se(b.get(),s,r,.5);P(h,h,n.origin);const p=Se(b.get(),o,l,.5);P(p,n.origin,p),Se(n.basis1,h,p,.5);const g=Se(b.get(),l,s,.5);P(g,g,n.origin);const u=Se(b.get(),r,o,.5);P(u,n.origin,u),Se(n.basis2,g,u,.5);const v=xe(b.get(),n.basis1,n.basis2),f=xe(v,v,n.basis1);return ot(f,f),be(n.basis2,f,Ot(n.basis2,f)),be(n.basis1,n.basis1,1+i/Ye(n.basis1)),be(n.basis2,n.basis2,1+i/Ye(n.basis2)),bn(n),n}let W=class extends we.EventedMixin($t){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new Js,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new ie,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=Ue(),this.mapBoundsStart=Ue(),this.displayBounds=Ue(),this.displayBoundsStart=Ue(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new ze({graphic:this.graphic});const t=this.graphic.geometry;this.editGeometryOperations=Pt.fromGeometry(t,this.view.state.viewingMode),this.graphicMoveManipulation=new sa({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=wn(this.view,On.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Gn,this.handles.add(this.watch("enableZ",()=>this._updateManipulatorAvailability(this.moveZManipulator,O.TRANSLATE_Z))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(s=>{const r=An(this.view,s);return this.handles.add(this.watch("enableScaling",()=>this._updateManipulatorAvailability(r,O.SCALE))),r.events.on("grab-changed",o=>this._onResizeGrab(o)),this.handles.add(this._createResizeDragPipeline(r,s)),r}),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=Rn(this.view.toolViewManager.textures),this.rotateManipulator=Dn(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",()=>this._updateManipulatorAvailability(this.rotateManipulator,O.ROTATE))),this.rotateManipulator.events.on("grab-changed",s=>{this._onRotateGrab(s)}),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const e=Vt({view:this.view,graphic:this.graphic,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>Ze()});c(e)&&(this.outlineVisualElement=e.visualElement instanceof Ve?e.visualElement:null),c(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),this.handles.add(e),this.handles.add([this.graphicState.on("changed",()=>this._onGeometryChanged()),this.graphicState.watch("displaying",()=>this._updateAllManipulatorAvailability()),Pe(this.graphicState,"isDraped",()=>this._graphicDrapedChanged()),this.view.trackGraphicState(this.graphicState)]);const a=this.view.pointsOfInterest;a&&this.handles.add(a.centerOnSurfaceFrequent.watch("location",()=>this._updateDisplayBounds()));const i=s=>{this.handles.add(s.events.on("grab-changed",()=>{this.grabbing=s.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(i);const n=(s,r)=>{this.handles.add(s.events.on("immediate-click",o=>{r===O.TRANSLATE_XY&&this.emit("immediate-click",D(G({},o),{graphic:this.graphic})),o.stopPropagation()}))};this._forEachManipulator(n),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this.finishToolCreation()}_graphicDrapedChanged(){this.handles.remove(Ka),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",t=>{c(this.attachmentOrigin)&&ii(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),Ka)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const a=this.grabbing&&!t.grabbing;if(t.interactive=!a,t instanceof j){const i=this.graphicState.displaying,n=this.enableZ&&$e(this.graphic);switch(e){case O.ROTATE:t.available=i&&this.enableRotation;break;case O.SCALE:t.available=i&&(this.enableScaling||this.enableRotation||n),t.interactive=!a&&this.enableScaling,t.state=this.enableScaling?Tn:$n;break;case O.TRANSLATE_Z:t.available=i&&n;break;default:t.available=i}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach(e=>t(e,O.SCALE)),t(this.rotateManipulator,O.ROTATE),t(this.moveZManipulator,O.TRANSLATE_Z)}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,a=e.components[0].edges[0],i=Wt(ke.get(),a.leftVertex.pos,a.rightVertex.pos);Ft(i,i);const n=Xt(Zt(this.view,this.graphic),t.extent.center);let s=sr*this.view.pixelSizeAt(n);const r=this.view.spatialReference;r!==t.spatialReference&&(s*=Ea(r)/Ea(t.spatialReference)),ar(i,e,s,this.mapBounds)}_updateDisplayBounds(){const t=this.graphic.geometry;if(y(t))return;const e=c(this.outlineVisualElement)&&!this.graphicState.isDraped&&c(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Zt(this.view,this.graphic);this.attachmentOrigin=Xt(e,t.extent.center);const a=c(e)?e.z:Qt(this.mapBounds.origin,this.view.elevationProvider,Rt.fromElevationInfo(L(this.graphic)),this.view.renderCoordsHelper),i=_e(this.mapBounds);i.origin[2]=a,ir(i,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return nr*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((t,e,a)=>this._applyGraphicMoveSteps(e,a))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return ae(this.moveZManipulator,(a,i,n)=>{const s=ui(a.renderLocation),r=i.next(ri(t,s,e)).next(qe());this._applyGraphicMoveSteps(r,n)})}_applyGraphicMoveSteps(t,e){const a=t.next(i=>(i.action==="start"&&(this.inputState={type:"move"},_e(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY})),i)).next(Fe()).next(this._moveDragUpdateGeometry()).next(i=>{const n={graphic:this.graphic,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY};switch(i.action){case"start":case"update":(i.mapEnd.x-i.mapStart.x||i.mapEnd.y-i.mapStart.y||i.mapEnd.z-i.mapStart.z)&&this.emit("graphic-translate",n);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",n)}return i});return e.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_moveDragUpdateGeometry(){return t=>{if(y(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const n of this.editGeometryOperations.data.components)e.push(...n.vertices);const a=t.action==="start"?ce.NEW_STEP:ce.ACCUMULATE_STEPS,i=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,a);return St(i,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);wa(this.displayBounds.plane,e,b.get())&&(_e(this.displayBounds,this.displayBoundsStart),_e(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return ae(t,(a,i,n)=>{y(this.inputState)||(i.next(s=>(s.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),s)).next(Yt(this.view,this.displayBoundsStart.plane)).next(s=>D(G({},s),{handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(s=>{const r={graphic:this.graphic,xScale:s.factor1,yScale:s.factor2};switch(s.action){case"start":case"update":this.emit("graphic-scale",r);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",r)}return s}),n.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,a=t.handle.direction,i=this.displayBoundsMargin,n=this.displayBoundsMarginStart,s=nt(b.get(),e.origin);_t(s,s,e.basis1,-a[0]),_t(s,s,e.basis2,-a[1]);const r=P(b.get(),t.renderEnd,s),o=P(b.get(),t.renderStart,s),l=fi(t.handle),h=Oa(e),p=Oa(this.displayBounds)/h,g=(u,v)=>{if(u===0)return 1;let f=Ye(v),w=.5*u*Ot(v,r)/f;const A=w<0?-1:1;l&&(w+=(f-.5*u*Ot(v,o)/f)*A*p);const M=f<1.5*n?1:ei;return f=Math.max(f-n,ei),A>0&&(w-=i),A*Math.max(A*(w/f),M)};return D(G({},t),{factor1:g(a[0],e.basis1),factor2:g(a[1],e.basis2)})}}_resizeDragUpdateGeometry(){return t=>{const e=nt($(),this.mapBoundsStart.origin);_t(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),_t(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const a=fe(In(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);Ft(a,a);const i=[];for(const r of this.editGeometryOperations.data.components)i.push(...r.vertices);const n=t.action==="start"?ce.NEW_STEP:ce.ACCUMULATE_STEPS,s=this.editGeometryOperations.scaleVertices(i,e,a,t.factor1,t.factor2,n,Aa.REPLACE);return _e(this.mapBoundsStart,this.mapBounds),St(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=Pn(this.displayBounds,this.view.renderCoordsHelper,Vn.HEADING,ea()),a=this._calculatePickRay(t.screenPoint);wa(e,a,b.get())&&(_e(this.displayBounds,this.displayBoundsStart),_e(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return ae(t,(e,a,i)=>{const n=this.inputState;y(n)||(a.next(s=>(s.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),s)).next(Yt(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdateGeometry()).next(s=>{const r={graphic:this.graphic,angle:pt(s.rotateAngle)};switch(s.action){case"start":case"update":this.emit("graphic-rotate",r);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",r)}return s}),i.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const a=ut(t.rotatePlane),i=gi(e.renderStart,e.renderEnd,this.displayBounds.origin,a);return D(G({},e),{rotateAxis:a,rotateAngle:i})}}_rotateDragUpdateGeometry(){return t=>{const e=nt($(),this.mapBoundsStart.origin),a=[];for(const s of this.editGeometryOperations.data.components)a.push(...s.vertices);const i=t.action==="start"?ce.NEW_STEP:ce.ACCUMULATE_STEPS,n=this.editGeometryOperations.rotateVertices(a,e,t.rotateAngle,i,Aa.REPLACE);return _e(this.mapBoundsStart,this.mapBounds),St(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=zn(),a=Cn(t);return Ln(this.view.state.camera,a,e),ot(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=Hn(this.displayBounds,Z.get());Nn(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach((e,a)=>{kn(e,this.resizeHandles[a],t,this.displayBounds)})}_updateZMoveHandle(t,e){const a=this.displayBounds,i={basis:a.basis1,direction:-1,position:P(b.get(),a.origin,a.basis1),edge:2},n=Z.get();Fn(n,e,i.edge*Math.PI/2),n[12]=0,n[13]=0,n[14]=0,t.modelTransform=n,t.renderLocation=i.position}_cancel(){const t=this.editGeometryOperations.lastOperation;y(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,Ja(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,Ja(E(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,St(E(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};m([_({constructOnly:!0,nonNullable:!0})],W.prototype,"view",void 0),m([_({constructOnly:!0,nonNullable:!0})],W.prototype,"graphic",void 0),m([_({constructOnly:!0,nonNullable:!0})],W.prototype,"enableZ",void 0),m([_()],W.prototype,"enableRotation",void 0),m([_()],W.prototype,"enableScaling",void 0),m([_()],W.prototype,"preserveAspectRatio",null),m([_()],W.prototype,"grabbing",void 0),m([_()],W.prototype,"inputState",void 0),m([_({readOnly:!0})],W.prototype,"type",void 0),W=m([Ee("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],W);const Ka="draped-elevation-changes",nr=10,sr=80,ei=1e-6;export{Le as DrawGraphicTool3D,W as ExtentTransformTool,ve as GraphicMoveTool,k as GraphicReshapeTool,q as GraphicTransformTool};
