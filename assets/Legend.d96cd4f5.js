var Yt=Object.defineProperty;var it=Object.getOwnPropertySymbols;var Zt=Object.prototype.hasOwnProperty,es=Object.prototype.propertyIsEnumerable;var lt=(e,t,s)=>t in e?Yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,O=(e,t)=>{for(var s in t||(t={}))Zt.call(t,s)&&lt(e,s,t[s]);if(it)for(var s of it(t))es.call(t,s)&&lt(e,s,t[s]);return e};import{J as m,K as S,L as oe,M as He,az as ts,aB as Ue,cm as me,si as ss,sj as is,sk as ls,sl as rs,j9 as We,b_ as ns,sm as as,sn as os,l as k,so as cs,qG as rt,qF as ds,en as je,sp as us,oe as gt,sq as hs,sr as bt,i7 as ys,bY as vt,S as _t,G as $e,a9 as Ge,a_ as _e,b0 as ye,ss as ps,b6 as J,hb as ms,st as fs,fO as F,br as Re,su as Q,lx as gs,bU as nt,kB as de,sv as bs,sw as vs,sx as _s,b$ as Ls,qe as ws,sy as Ss,sz as Is,O as Ve,sA as Cs,mR as As,sB as $s,qw as u,sC as fe,sD as Fe,qE as ke,qD as Es,fB as W,sE as Me,sF as Se,sG as Rs,sH as Qe,sI as Le,sJ as Vs,sK as H,m5 as xs}from"./vendor.c28ea743.js";import{c as zs}from"./ExportImageParameters.683d4f1c.js";import{o as Ts}from"./rendererConversion.c9355bb9.js";import{l as Fs,M as ks,A as Ms,G as Bs,j as Ns,T as Os,E as Ds,V as at,D as qs}from"./renderUtils.5dca719b.js";import{getSymbolLayerFill as Ps}from"./previewSymbol3D.649d9591.js";import"./sublayerUtils.0c3cf1a5.js";import"./colorUtils.7c4b6dc5.js";import"./webStyleSymbolUtils.97c26dde.js";const pe=-1;let D=class extends He{constructor(e){super(e),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=ts("mapview-transitions-duration"),this.effects=[]}set effect(e){if(this._get("effect")!==(e=e||"")){this._set("effect",e);try{this._transitionTo(ot(e))}catch(t){this._transitionTo([]),Ue.getLogger(this.declaredClass).warn("Invalid Effect",{effect:e,error:t})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(e){this._updateForScale(e)}get transitioning(){return this._to!==null}canTransitionTo(e){try{return this.scale>0&&ct(this._current,ot(e),this.scale)}catch{return!1}}transitionStep(e,t){this._applyTimeTransition(e),this._updateForScale(t)}end(){this._applyTimeTransition(this.duration)}_transitionTo(e){this.scale>0&&ct(this._current,e,this.scale)?(this._final=e,this._to=me(e),Hs(this._current,this._to,this.scale),this._from=me(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._set("effects",this._current[0]?me(this._current[0].effects):[])}_applyTimeTransition(e){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let s=0;s<this._current.length;s++){const i=this._current[s],l=this._from[s],r=this._to[s];i.scale=Us(l.scale,r.scale,t);for(let n=0;n<i.effects.length;n++){const a=i.effects[n],o=l.effects[n],d=r.effects[n];a.interpolate(o,d,t)}}t===1&&(this._current=this._final,this._set("effects",this._current[0]?me(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(e){if(this._set("scale",e),this._current.length===0)return;const t=this._current,s=this._current.length-1;let i,l,r=1;if(t.length===1||e>=t[0].scale)l=i=t[0].effects;else if(e<=t[s].scale)l=i=t[s].effects;else for(let n=0;n<s;n++){const a=t[n],o=t[n+1];if(a.scale>=e&&o.scale<=e){r=(e-a.scale)/(o.scale-a.scale),i=a.effects,l=o.effects;break}}for(let n=0;n<this.effects.length;n++)this.effects[n].interpolate(i[n],l[n],r)}};function ot(e){const t=ss(e)||[];return Ws(t)?[{scale:pe,effects:t}]:t}function ct(e,t,s){var i,l,r,n;return(i=e[0])==null||!i.effects||(l=t[0])==null||!l.effects?!0:!((((r=e[0])==null?void 0:r.scale)===pe||((n=t[0])==null?void 0:n.scale)===pe)&&(e.length>1||t.length>1)&&s<=0)&&is(e[0].effects,t[0].effects)}function Hs(e,t,s){var i,l;const r=e.length>t.length?e:t,n=e.length>t.length?t:e,a=n[n.length-1],o=(i=a==null?void 0:a.scale)!=null?i:s,d=(l=a==null?void 0:a.effects)!=null?l:[];for(let c=n.length;c<r.length;c++)n.push({scale:o,effects:[...d]});for(let c=0;c<r.length;c++)n[c].scale=n[c].scale===pe?s:n[c].scale,r[c].scale=r[c].scale===pe?s:r[c].scale,ls(n[c].effects,r[c].effects)}function Us(e,t,s){return e+(t-e)*s}function Ws(e){const t=e[0];return!!t&&"type"in t}m([S()],D.prototype,"_to",void 0),m([S()],D.prototype,"duration",void 0),m([S({value:""})],D.prototype,"effect",null),m([S({readOnly:!0})],D.prototype,"effects",void 0),m([S({readOnly:!0})],D.prototype,"hasEffects",null),m([S({value:0})],D.prototype,"scale",null),m([S({readOnly:!0})],D.prototype,"transitioning",null),D=m([oe("esri.layers.effects.EffectView")],D);const js=(e,t)=>{const s=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t!=null&&t.levels?t.levels[s]:null};function Gs(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const s=e.visualVariables.find(l=>l.type==="size"),i=js(t,s);return i?new rs({field:s.field,minSize:i[2].size,minDataValue:i[2].value,maxSize:i[3].size,maxDataValue:i[3].value}):null}const Qs=/^-?(\d+)(\.(\d+))?$/i;function Ks(e,t){return e-t}function Js(e,t){let s,i;return s=Number(e.toFixed(t)),s<e?i=s+1/10**t:(i=s,s-=1/10**t),s=Number(s.toFixed(t)),i=Number(i.toFixed(t)),[s,i]}function Xs(e,t,s,i,l){const r=we(e,t,s,i),n=r.previous==null||r.previous<=l,a=r.next==null||r.next<=l;return n&&a||r.previous+r.next<=2*l}function Ie(e){const t=String(e),s=t.match(Qs);if(s&&s[1])return{integer:s[1].split("").length,fractional:s[3]?s[3].split("").length:0};if(t.toLowerCase().indexOf("e")>-1){const i=t.split("e"),l=i[0],r=i[1];if(l&&r){const n=Number(l);let a=Number(r);const o=a>0;o||(a=Math.abs(a));const d=Ie(n);return o?(d.integer+=a,a>d.fractional?d.fractional=0:d.fractional-=a):(d.fractional+=a,a>d.integer?d.integer=1:d.integer-=a),d}}return{integer:0,fractional:0}}function we(e,t,s,i){const l={previous:null,next:null};if(s!=null){const r=e-s,n=t-s-r;l.previous=Math.floor(Math.abs(100*n/r))}if(i!=null){const r=i-e,n=i-t-r;l.next=Math.floor(Math.abs(100*n/r))}return l}function Ce(e,t={}){const s=e.slice(0),{tolerance:i=2,strictBounds:l=!1,indexes:r=s.map((n,a)=>a)}=t;r.sort(Ks);for(let n=0;n<r.length;n++){const a=r[n],o=s[a],d=a===0?null:s[a-1],c=a===s.length-1?null:s[a+1],y=Ie(o).fractional;if(y){let p,g=0,f=!1;for(;g<=y&&!f;){const _=Js(o,g);p=l&&n===0?_[1]:_[0],f=Xs(o,p,d,c,i),g++}f&&(s[a]=p)}}return s}const Ys={maximumFractionDigits:20};function Zs(e){return We(e,Ys)}const Lt="<",wt=">",ei=os("short-date");function St(e,t,s,i){let l="";t===0?l=`${Lt} `:t===s&&(l=`${wt} `);let r=null;return r=i?as(e,ei):Zs(e),l+r}const ti=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function Be(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const t=e.visualVariables.find(n=>n.type==="color");if(!t)return null;let s=null,i=null;if(t.stops){if(t.stops.length===1)return t.stops[0].color;s=t.stops[0].value,i=t.stops[t.stops.length-1].value}const l=s+(i-s)/2,{getColor:r}=await import("./vendor.c28ea743.js").then(function(n){return n.vA});return r(t,l)}async function It(e,t){const s=e.trailWidth||1,i=t||await Be(e)||e.color;return new ns({cap:"butt",color:i,width:s})}const si=new k([64,64,64]);function Ct(e,t){const s=[],i=e.length-1;return e.length===5?s.push(0,2,4):s.push(0,i),e.map((l,r)=>s.indexOf(r)>-1?St(l,r,i,t):null)}async function dt(e,t,s){let i=!1,l=[],r=[];if(e.stops){const d=e.stops;l=d.map(c=>c.value),i=d.some(c=>!!c.label),i&&(r=d.map(c=>c.label))}const n=l[0],a=l[l.length-1];if(n==null&&a==null)return null;const o=i?null:Ct(l,s);return(await Promise.all(l.map(async(d,c)=>({value:d,color:e.type==="opacity"?await ii(d,e,t):(await import("./vendor.c28ea743.js").then(function(y){return y.vA})).getColor(e,d),label:i?r[c]:o[c]})))).reverse()}async function ii(e,t,s=si){const i=new k(s),l=(await import("./vendor.c28ea743.js").then(function(r){return r.vA})).getOpacity(t,e);return l!=null&&(i.a=l),i}function li(e){let t=!1,s=[],i=[];s=e.map(a=>a.value),t=e.some(a=>!!a.label),t&&(i=e.map(a=>a.label));const l=s[0],r=s[s.length-1];if(l==null&&r==null)return null;const n=t?null:Ct(s,!1);return s.map((a,o)=>({value:a,color:At(a,e),label:t?i[o]:n[o]})).reverse()}function At(e,t){const{startIndex:s,endIndex:i,weight:l}=ri(e,t);if(s===i)return t[s].color;const r=k.blendColors(t[s].color,t[i].color,l);return new k(r)}function ri(e,t){let s=0,i=t.length-1;return t.some((l,r)=>e<l.value?(i=r,!0):(s=r,!1)),{startIndex:s,endIndex:i,weight:(e-t[s].value)/(t[i].value-t[s].value)}}function ni(e,t){let s=[];if(e&&e.type==="multipart")e.colorRamps.reverse().forEach(function(i,l){l===0?s.push({value:t.max,color:new k(i.toColor),label:"high"}):s.push({value:null,color:new k(i.toColor),label:""}),l===e.colorRamps.length-1?s.push({value:t.min,color:new k(i.fromColor),label:"low"}):s.push({value:null,color:new k(i.fromColor),label:""})});else{let i,l;e&&e.type==="algorithmic"?(i=e.fromColor,l=e.toColor):(i=[0,0,0,1],l=[255,255,255,1]),s=[{value:t.max,color:new k(l),label:"high"},{value:t.min,color:new k(i),label:"low"}]}return s}function ai(e){let t=e.colorStops,s=t.length-1;if(t&&t[0]){const i=t[s];i&&i.ratio!==1&&(t=t.slice(0),t.push(new cs({ratio:1,color:i.color})),s++)}return t.map((i,l)=>{let r="";return l===0?r="low":l===s&&(r="high"),{color:i.color,label:r,ratio:i.ratio}}).reverse()}const ut={HH:315,HL:45,LL:135,LH:225},oi={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function ci(e){if(!e)return;const{type:t}=e;if(t.indexOf("3d")>-1)return Ps(e.symbolLayers.getItemAt(0));if(t==="simple-line"){const s=rt(e);return s&&s.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const s=rt(e);return s&&s.color}return ds(e)}function di(e,t){const s=t.HH.label,i=t.LL.label,l=t.HL.label,r=t.LH.label;switch(e){case"HH":default:return{top:s,bottom:i,left:l,right:r};case"HL":return{top:l,bottom:r,left:i,right:s};case"LL":return{top:i,bottom:s,left:r,right:l};case"LH":return{top:r,bottom:l,left:s,right:i}}}function ui(e){const{focus:t,infos:s,numClasses:i}=e,l=oi[i],r={};s.forEach(a=>{r[a.value]={label:a.label,fill:ci(a.symbol)}});const n=[];for(let a=0;a<i;a++){const o=[];for(let d=0;d<i;d++){const c=r[l[a][d]];o.push(c.fill)}n.push(o)}return{type:"relationship-ramp",numClasses:i,focus:t,colors:n,labels:di(t,r),rotation:$t(t)}}function $t(e){let t=ut[e];return e&&t==null&&(t=ut.HH),t||0}const Ne=30,Oe=12,Et=[255,255,255],Rt=[200,200,200],le=[128,128,128],hi=20,yi=5;function pi(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function mi(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function fi(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function gi(e){return e.declaredClass==="esri.symbols.TextSymbol"}function bi(e,t){const s=e.length-1;return e.map((i,l)=>St(i,l,s,t))}async function vi(e,t,s,i,l,r){var n,a;const o=t.legendOptions,d=o&&o.customValues,c=await wi(e,s),y=!!c,p=!!d,g=t.minSize!=null&&t.maxSize!=null,f=t.stops&&t.stops.length>1,_=!!t.target;if(!y||!p&&!(g||f&&!_))return;const h=je(c);let w=null,b=null,C=null;b=h&&!f?Ce([t.minDataValue,t.maxDataValue]):d||await Ii(t,c,i,l);const I=e==null?void 0:e.authoringInfo,A=(I==null?void 0:I.type)==="univariate-color-size",E=A&&(I==null?void 0:I.univariateTheme)==="above-and-below";if(!b&&f&&(b=t.stops.map(R=>R.value),w=t.stops.some(R=>!!R.label),e.type==="flow"&&(b=Ce(b)),w&&(C=t.stops.map(R=>R.label))),h&&((n=b)==null?void 0:n.length)>2&&!E&&(b=[b[0],b[b.length-1]]),!b)return null;A&&((a=b)==null?void 0:a.length)!==5&&(b=zt({minSize:b[0],maxSize:b[b.length-1]}));const T=h?_i(e,b):null,j=us(c),N=w?null:bi(b,r);return(await Promise.all(b.map(async(R,P)=>{const q=h?T[P]:await te(t,c,R,i,l);return{value:R,symbol:$i(E&&e.type==="class-breaks"?Li(e,P):c,q),label:w?C[P]:N[P],size:q,outlineSize:j}}))).reverse()}function _i(e,t){const s=e==null?void 0:e.authoringInfo,i=(s==null?void 0:s.type)==="univariate-color-size";let l=[Oe,Ne];if(i){const r=t[0],n=t[t.length-1],a=Oe,o=Ne;l=t.map(d=>a+(d-r)/(n-r)*(o-a))}return i&&(s==null?void 0:s.univariateTheme)==="below"&&l.reverse(),l}function Li(e,t){const s=e.classBreakInfos,i=s.length,l=i<2||!(t>=2)?s[0].symbol.clone():s[i-1].symbol.clone();return e.visualVariables.some(r=>r.type==="color")&&(l.type.indexOf("3d")>-1?Vt(l):xt(l)),l}async function wi(e,t){if(e.type==="flow")return It(e,t);let s=null,i=null;if(e.type==="simple")s=e.symbol;else if(e.type==="class-breaks"){const l=e.classBreakInfos;s=l&&l[0]&&l[0].symbol,i=l.length>1}else if(e.type==="unique-value"){const l=e.uniqueValueInfos;s=l&&l[0]&&l[0].symbol,i=l.length>1}return!s||Si(s)?null:(s=s.clone(),(t||i)&&(s.type.indexOf("3d")>-1?Vt(s):xt(s)),s)}function Si(e){return e?gt(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.indexOf("fill")!==-1:!1}function Vt(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:le}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:Rt}:(t.material={color:Et},t.outline={color:le,size:1.5})})}function xt(e){const t=hs();if(e.type==="cim")bt(e,new k(Rt));else if(e.type.indexOf("line")!==-1)e.color=le;else if(e.color=t?le:Et,e.type==="simple-marker")if(e.outline){var s,i;((s=e.outline)==null||(i=s.color)==null?void 0:i.toHex())==="#ffffff"&&(e.outline.color=le)}else e.outline={color:le,width:1.5}}async function Ii(e,t,s,i){const l=(await import("./vendor.c28ea743.js").then(function(a){return a.vA})).getSizeRangeAtScale(e,s,i),r=l&&zt(l);if(!l&&!r)return;let n=r.map(a=>Ci(a,e,l));n=Ce(n);for(let a=1;a<n.length-1;a++){const o=await Ai(e,t,n[a],n[a-1],s,i);o&&(n[a]=o[0],r[a]=o[1])}return n}function zt(e){const t=e.minSize,s=e.maxSize,i=yi,l=(s-t)/(i-1),r=[];for(let n=0;n<i;n++)r.push(t+l*n);return r}function Ci(e,t,s){const i=s.minSize,l=s.maxSize,r=t.minDataValue,n=t.maxDataValue;let a=null;return e<=i?a=r:e>=l?a=n:a=(e-i)/(l-i)*(n-r)+r,a}async function Ai(e,t,s,i,l,r){const n=await te(e,t,s,l,r),a=await te(e,t,i,l,r),o=Ie(s),d=o.fractional,c=hi;let y=o.integer,p=null,g=null;s>0&&s<1&&(p=10**d,y=Ie(s*=p).integer);for(let f=y-1;f>=0;f--){const _=10**f;let h=Math.floor(s/_)*_,w=Math.ceil(s/_)*_;p!=null&&(h/=p,w/=p);let b=(h+w)/2;[,b]=Ce([h,b,w],{indexes:[1]});const C=await te(e,t,h,l,r),I=await te(e,t,w,l,r),A=await te(e,t,b,l,r),E=we(n,C,a,null),T=we(n,I,a,null),j=we(n,A,a,null);let N=E.previous<=c,R=T.previous<=c;if(N&&R&&(E.previous<=T.previous?(N=!0,R=!1):(R=!0,N=!1)),N?g=[h,C]:R?g=[w,I]:j.previous<=c&&(g=[b,A]),g)break}return g}async function te(e,t,s,i,l){const{getSize:r}=await import("./vendor.c28ea743.js").then(function(n){return n.vA});return r(e,s,{scale:i,view:l,shape:t.type==="simple-marker"?t.style:null})}function $i(e,t){const s=e.clone();if(gt(s))je(s)||s.symbolLayers.forEach(i=>{i.type!=="fill"&&(i.size=t)});else if(pi(s))s.size=t;else if(mi(s)){const i=s.width,l=s.height;s.height=t,s.width=t*(i/l)}else fi(s)?s.width=t:gi(s)&&s.font&&(s.font.size=t);return s}Ue.getLogger("esri.renderers.support.utils");function Ei(e){const s=Math.floor(Math.log10(Math.abs(e)))+1,i=s<4||s>6?4:s,l=1e6,r=Math.abs(e)>=l?"compact":"standard";return We(e,{notation:r,minimumSignificantDigits:2,maximumSignificantDigits:i})}const U=Ue.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),Ri="https://utility.arcgis.com/sharing/tools/legend",Vi="esri.layers.ImageryLayer",xi="esri.layers.ImageryTileLayer",zi="esri.layers.WCSLayer",ge=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Ti=new ys({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ht={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},be=new vt({size:6,outline:{color:[128,128,128,.5],width:.5}}),Fi=new _t({style:"solid"});function De(e){return e.type==="flow"}function Tt(e){return e.type==="vector-field"}function Ft(e){return e.type==="raster-colormap"}function kt(e){return e.type==="raster-stretch"}function Mt(e){return e.type==="raster-shaded-relief"}function se(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ie(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function qe(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function Bt(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function ki(e){return Ke(e)||Je(e)||Xe(e)||Mi(e)}function Mi(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function Ke(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function Je(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function Xe(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Nt(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function Bi(e,t){return se(e)||ie(e)||qe(e)||Bt(e)||Nt(e)?t.type==="2d"||Ts(e):kt(e)||Ft(e)||Mt(e)||Ke(e)||Je(e)||Xe(e)||Tt(e)||De(e)}function yt(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function Ni(e){return e.declaredClass==="esri.layers.VoxelLayer"}function Oi(e){return e.declaredClass==="esri.layers.WMSLayer"}function Di(e){return e.declaredClass==="esri.layers.WMTSLayer"}function pt(e){return e.declaredClass==="esri.layers.MapImageLayer"}function qi(e){return e.declaredClass==="esri.layers.TileLayer"}function Pi(e){return e.declaredClass==="esri.layers.FeatureLayer"}function ue(e){return e.declaredClass===Vi}function xe(e){return e.declaredClass===xi}function Hi(e){return e.declaredClass===zi}function Ui(e){return e.type==="stretch-ramp"}function Wi(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"}function ji(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"&&(t==null?void 0:t.univariateTheme)==="above-and-below"}const Gi=new vt({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let X={},V=class extends He{constructor(e){super(e),this._handles=new $e,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new Ge,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([_e(this,"children","change",t=>{const{added:s,removed:i}=t,l=this._handles;s.forEach(r=>{const n=`activeLayerInfo-ready-watcher-${r.layer.uid}`;l.add(ye(r,"ready",e),n)}),i.forEach(r=>l.remove(r.layer.uid)),e()})]),this.keepCacheOnDestroy||(X={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(X=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new D,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var e;const t=this.layer.opacity,s=(e=this.parent)==null?void 0:e.opacity,i=this.layer.parent,l=i&&"uid"in i?this._getParentLayerOpacity(i):null;return s!=null?s*t:l!=null?l*t:t}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect)||"featureReduction"in e&&e.featureReduction&&e.featureReduction.type==="cluster")return!0;if("renderer"in e&&e.renderer){if(e.renderer.type==="dot-density")return!0;const t=e.get("renderer.valueExpression");if(ge.test(t))return!0;const s=e.get("renderer.visualVariables");if(s)return s.some(i=>this._isScaleDrivenSizeVariable(i))}return this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,s=>{if(Pi(s))return this._getRendererLegendElements(s.renderer,{title:s.title});if(s.featureSet&&s.featureSet.features.length){const i=s.layerDefinition,l=i&&i.drawingInfo,r=l&&ps(l.renderer),n=Ti.read(i.geometryType);return r?this._getRendererLegendElements(r,{title:s.name,geometryType:n}):(U.warn("drawingInfo not available!"),null)}return null});try{const s=[];await J(t).then(i=>{i.forEach(({value:l})=>l&&s.push(...l))}),this.legendElements=s,this.notifyChange("ready")}catch(s){U.warn("error while building legend for layer!",s)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){U.warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){const e=this.layer;if(Ni(e))this._constructLegendElementsForVoxellayer();else if(Di(e))this._constructLegendElementsForWMTSlayer();else if(Oi(e))await this._constructLegendElementsForWMSSublayers();else if(yt(e))await this._constructLegendElementsForBuildingSceneLayer();else if(pt(e)||qi(e)||yt(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let i="default";if(ue(e)){var t,s;const l=e;i=((l==null||(t=l.renderingRule)==null?void 0:t.functionName)||"default")+"_"+((s=e.bandIds)!=null&&s.length?e.bandIds.join(""):"###")}await this._getLegendLayers(`${e.uid}-${i}`).then(async l=>{this.legendElements=[],this.notifyChange("ready");const r=l.map(async n=>{if(ue(e)||xe(e)){const o=e.watch(["renderingRule","bandIds"],()=>ms(async()=>{X.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this._handles.add(o,"imageryLayers-watcher")}const a=this._generateSymbolTableElementForLegendLayer(n);a&&a.infos.length&&(ue(e)&&(a.title=e.title),this.legendElements.push(a)),this.notifyChange("ready")});await J(r)}).catch(l=>{U.warn("Request to server for legend has failed!",l)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!s&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await fs(t,"updating");const i=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return i.geometry=this.view.extent,(s?"queryFeatureCount"in t&&await t.queryFeatureCount(i):"queryFeatureCount"in e&&await e.queryFeatureCount(i))!==0}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,s=t.minSize,i=t.maxSize;return typeof s=="object"&&s?this._isScaleDrivenSizeVariable(s):typeof i=="object"&&i?this._isScaleDrivenSizeVariable(i):!!t.expression||ge.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(s=>this._isLayerScaleDriven(s));const t=e.parent;if(e.loaded===!1&&t&&pt(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add(F(e,"style",()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=Re(e.getVariableStyle(null)),s=[];var i;if(t){if((i=t.uniqueValues)!=null&&i.length){const n=[];t.uniqueValues.forEach(a=>{a.enabled&&n.push({label:a.label||`${a.value}`,value:a.value,symbol:new _t({color:a.color,outline:null})})}),n.length&&s.push({type:"symbol-table",title:t.label,infos:n})}else if(t.transferFunction){const{colorStops:n,stretchRange:a}=t.transferFunction,o=n.toArray().reverse(),d=a.map((y,p)=>`${p===0?Lt:wt} ${Ei(y)}`).reverse(),c=o.map(y=>({color:y.color,value:null,label:null}));c[0].label=d[0],c[c.length-1].label=d[1],s.push({type:"color-ramp",title:t.label,infos:c,preview:Q(o.map(y=>y.color))})}}const l=e.opacity,r=s.reduce((n,a)=>n.concat(this._getAllInfos(a)),[]).filter(n=>!(n==null||!n.symbol)).map(n=>this._getSymbolPreview(n,l));await J(r),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(F(this.layer,"activeLayer",()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(s=>e.styleId===s.id&&(t=s.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t=O(O({},e.customParameters),e.customLayerParameters)),this._handles.add(F(this.layer,"sublayers",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const i=e.toArray();for(const l of i){const r=l.watch(["title","visible","legendEnabled"],()=>this._constructLegendElementsForWMSSublayers());if(this._handles.add(r,"wms-sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled){const n=await this._generateSymbolTableElementForWMSSublayer(l,t);n&&n.infos.length&&s.unshift(n)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(i=>i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var s;let i=e.legendUrl;if(!i)return;const l={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(i=gs(i,t));let r=null;const n=(s=e.layer)==null?void 0:s.opacity;try{r=(await nt(i,{responseType:"image"})).data,r&&(r.style.opacity=n)}catch{}return l.infos.push({src:i,preview:r,opacity:n}),l}_getLegendLayers(e,t){const s=X&&X[e];return s?Promise.resolve(s):this._legendRequest(t).then(i=>{const l=i.layers;return X[e]=l,l})}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(ue(t)){const l=t.exportImageServiceParameters.renderingRule;if(l&&(s.renderingRule=JSON.stringify(l.rasterFunctionDefinition||l.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:r,viewId:n,customParameters:a}=t;s=O(O({raster:r,viewId:n},s),a)}}let i=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const l=i.indexOf("?");l>-1?i=i.substring(0,l)+"/legend"+i.substring(l):i+="/legend"}else{const l=i.toLowerCase().indexOf("/rest/"),r=i.substring(0,l)+i.substring(l+5,i.length);i=Ri+"?soapUrl="+encodeURI(r)+"&returnbytes=true"}return nt(i,{query:s}).then(l=>l.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(F(e,"sublayers",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const i=e.toArray();for(const l of i){const r=l.watch(["renderer","opacity","title","visible"],()=>this._constructLegendElementsForBuildingSceneLayer());if(this._handles.add(r,"sublayers-watcher"),!this.respectLayerVisibility||l.visible){const n=l&&l.opacity!=null?l.opacity:null,a=n!=null?n*t:t;if(l.type==="building-group"){const o={type:"symbol-table",title:l.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(l.sublayers,a);o.infos.push(...d),s=[o,...s]}else l.renderer&&(s=[...await this._getRendererLegendElements(l.renderer,{title:l.title,opacity:a,sublayer:l}),...s])}}return s.filter(l=>!!l&&(!("infos"in l)||l.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(F(e,"sublayers",()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForSublayers(e,t,s){const i=this.layer;let l=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(r=this.sublayerIds.map(n=>i.findSublayerById(n)).filter(Boolean));for(const n of r){const a=n.watch("renderer, opacity, title, visible, legendEnabled",()=>this._constructLegendElementsForSublayers());if(this._handles.add(a,"sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n)){const o=n&&n.opacity!=null?n.opacity:null,d=o!=null?o*t:t;if(n.renderer&&!n.sublayers&&n.originIdOf("renderer")>de.SERVICE)await n.load(),l=[...await this._getRendererLegendElements(n.renderer,{title:n.title,opacity:d,sublayer:n}),...l];else{const c=await this._generateSymbolTableElementForSublayer(n,d,s);c&&l.unshift(c)}}}return l.filter(n=>!!n&&(!("infos"in n)||n.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const l=this.layer,r=e.source;let n=null;if(!(!r||r.type==="map-layer"&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in l&&l.gdbVersion)))||e.originIdOf("renderer")>de.SERVICE||e.originIdOf("labelingInfo")>de.SERVICE||e.originIdOf("labelsVisible")>de.SERVICE){const o=new zs({layer:this.layer});n=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const a=n||`${l.uid}-default`;(await this._getLegendLayers(a,n)).forEach(o=>s.set(o.layerId,o))}const i=s.get(e.id);if((!i||i!=null&&i.subLayerIds&&i.defaultVisibility)&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(i,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){var i;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const l=t==null?void 0:t.renderer;let r=(t==null?void 0:t.title)||e.layerName;if(l&&(!t||(t==null?void 0:t.originIdOf("renderer"))>de.SERVICE)){const o=(t==null?void 0:t.title)||this._getRendererTitle(l,t);o&&(r&&typeof o!="string"&&"title"in o&&(o.title=r),r=o)}const n={type:"symbol-table",title:r,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return((i=e.legendGroups)==null?void 0:i.length)>0?e.legendGroups.forEach(o=>{var d;const c={type:"symbol-table",title:o.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(y=>y.groupId===o.id),e.layerId,s)};((d=c.infos)==null?void 0:d.length)>0&&n.infos.push(c)}):n.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,s),n.infos.length>0?n:null}_generateSymbolTableElementInfosForLegendLayer(e,t,s){return e.map(i=>{let l=i.url;if(i.imageData&&i.imageData.length>0)l=`data:image/png;base64,${i.imageData}`;else{if(l.indexOf("http")===0)return null;l=bs(`${this.layer.url}/${t}/images/${l}`)}return{label:i.label,src:l,opacity:s==null?this.opacity:s,width:i.width,height:i.height}}).filter(i=>!!i)}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let i=null,l=null,r=!0;return!s.minScale&&s.minScale!==0||!s.maxScale&&s.maxScale!==0?(e.minScale===0&&s.tileInfo&&(i=s.tileInfo.lods[0].scale),e.maxScale===0&&s.tileInfo&&(l=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(i=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,l=Math.max(s.maxScale,e.maxScale)),(i>0&&i<this.scale||l>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||e.length===0)return e;const s=t.renderer,i=e.some(n=>n.values);let l=null,r=null;return i&&e.some((n,a)=>(n.values||(l=a,r=n,r.label||(r.label="others")),r!=null)),s?s.type==="unique-value"?r&&(e.splice(l,1),e.push(r)):s.type==="class-breaks"&&(r&&e.splice(l,1),e.reverse(),r&&e.push(r)):r&&(e.splice(l,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){return Bi(e,this.view)?ki(e)?this._constructPointCloudRendererLegendElements(e,t):Nt(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(U.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,i=[];let l=null,r=null;if(Ke(e))l={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(a=>{l.infos.unshift({label:a.label||a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:this._getAppliedCloneSymbol(be,a.color)})});else if(Je(e)){const a=e.stops;let o=null;if(a.length&&(a.length===1&&(o=a[0].color),!o)){const c=a[0].value,y=a[a.length-1].value;c!=null&&y!=null&&(o=At(c+(y-c)/2,a))}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(be,o||be.color)}]};const d=li(e.stops);r={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:d,preview:Q(d.map(c=>c.color))}}else Xe(e)&&(l={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(a=>{l.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:this._getAppliedCloneSymbol(be,a.color)})}));l&&l.infos.length&&i.push(l),r&&r.infos.length&&i.push(r);const n=i.reduce((a,o)=>a.concat(o.infos),[]).filter(a=>!!a.symbol).map(a=>this._getSymbolPreview(a,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return J(n).then(()=>i)}_getElementInfoForDotDensity(e,t){const{backgroundColor:s,outline:i,dotSize:l}=e,r=this.effectList,n=r==null?void 0:r.effects.map(g=>g.toJSON()),a=vs(n),o=l+"-"+t+"-"+s+"-"+(i&&JSON.stringify(i.toJSON()))+"-"+a,d=this._dotDensityUrlCache,c=d.has(o)?d.get(o):_s(e,t);d.set(o,c);const y={shape:{type:"image",x:0,y:0,width:c.width,height:c.height,src:c.src},fill:null,stroke:null,offset:[0,0]},p=Fs([[y]],[c.width,c.height],{effectView:this.effectList});return{opacity:1,src:c.src,preview:p,width:c.width,height:c.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,i={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach(l=>{const r=this._getElementInfoForDotDensity(e,l.color);r.label=l.label||l.valueExpressionTitle||l.field,i.infos.push(r)}),Promise.resolve([i])}async _constructRendererLegendElements(e,t={}){const{title:s,sublayer:i}=t,l=i||this.layer;let r=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const n=await this._getVisualVariableLegendElements(r,l)||[],a={type:"symbol-table",title:s||this._getRendererTitle(r,l),infos:[]};let o=null,d=!1;const c=new Set;if(De(r)&&!this._hasSizeRamp){const h=await It(r);a.infos.push({label:null,symbol:h})}else if(Wi(r)){let h=s;const w=ji(r)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",b=n.findIndex(T=>T.type==="color-ramp"),C=b!==-1?n.splice(b,1)[0]:null,I=n.findIndex(T=>T.type==="size-ramp"),A=I!==-1?n.splice(I,1)[0]:null,E=[];C&&(h=C.title,E.push(C)),A&&(h=A.title,E.push(A)),E.length>0&&n.push({type:w,title:h,infos:E})}else if(Bt(r)){const h=ai(r);n.push({type:"heatmap-ramp",title:s,infos:h,preview:Q(h.map(w=>w.color),{effectList:this.effectList})})}else if(qe(r)){const h=r&&r.authoringInfo;if(h&&h.type==="relationship"){const{focus:w,numClasses:b,field1:C,field2:I}=h;if(b&&C&&I){const A=[C,I];let E=$t(w)||0;for(const j of A){const{field:N,normalizationField:R,label:P}=j,q=P||{field:this._getFieldAlias(N,l),normField:R&&this._getFieldAlias(R,l)},ce=Gi.clone();ce.angle=E,a.infos.push({label:q,symbol:ce}),c.add(ce),E+=90}const T=ui({focus:w,numClasses:b,infos:r.uniqueValueInfos});n.unshift(T)}}else{const w=r.field;r.uniqueValueInfos.forEach(b=>{b.symbol&&a.infos.push({label:b.label||this._getDomainName(w,b.value,l)||b.value,value:b.value,symbol:b.symbol})})}r.defaultSymbol&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),d=!0)}else if(ie(r))o=this._isUnclassedRenderer(r),(!o||!this._hasSizeRamp)&&(r.classBreakInfos.forEach(h=>{h.symbol&&a.infos.unshift({label:h.label||(o?null:h.minValue+" - "+h.maxValue),value:[h.minValue,h.maxValue],symbol:h.symbol})}),o&&(a.title=null),this._updateInfosforClassedSizeRenderer(r,a.infos)),r.defaultSymbol&&!o&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),d=!0);else if(kt(r))if(xe(this.layer)||Hi(this.layer)){const h=this._constructTileImageryStretchRendererElements(r);Ui(h)?n.push(h):a.infos=h}else{const h=this.layer;let w,b;r.statistics&&r.statistics.length&&(w=r.statistics[0].min!=null?r.statistics[0].min:r.statistics[0][0],b=r.statistics[0].max!=null?r.statistics[0].max:r.statistics[0][1]);let C=[];const I=Re(h.renderingRule?await h.generateRasterInfo(h.renderingRule):h.serviceRasterInfo),A=I.keyProperties.BandProperties,E=ht[h.rasterInfo.pixelType.toLowerCase()];I.bandCount===1||h.bandIds&&h.bandIds.length===1?(w=w!=null?w:I.statistics?I.statistics[h.bandIds[0]].min:E[0],b=b!=null?b:I.statistics?I.statistics[h.bandIds[0]].max:E[1],w||b?n.push(this._getStretchLegendElements(r,{min:w,max:b})):this._getServerSideLegend()):I.bandCount>=3?A&&A.length>=I.bandCount?h.bandIds&&h.bandIds.length===3?(C=h.bandIds.map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):h.format==="lerc"?(C=[0,1,2].map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():h.format==="lerc"?(C=["band1","band2","band3"],a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():this._getServerSideLegend()}else if(Ft(r))r.colormapInfos.forEach(h=>{a.infos.push({label:h.label,value:h.value,symbol:this._getAppliedCloneSymbol(Fi,h.color)})});else if(se(r)){let h=r.symbol;switch(t.geometryType){case"point":h="pointSymbol"in l&&l.pointSymbol;break;case"polyline":h="lineSymbol"in l&&l.lineSymbol;break;case"polygon":h="polygonSymbol"in l&&l.polygonSymbol}r.symbol&&!this._hasSizeRamp&&a.infos.push({label:r.label,symbol:h})}else if(Tt(r)){r.outputUnit&&(this.title="("+r.toJSON().outputUnit+")"),a.title=r.attributeField;const h=r.getClassBreakInfos();h!=null&&h.length?h.forEach(w=>{a.infos.push({label:w.minValue+" - "+w.maxValue,symbol:w.symbol})}):a.infos.push({label:r.attributeField,symbol:r.getDefaultSymbol()})}else Mt(r)&&n.push(this._getStretchLegendElements(r,{min:0,max:255}));const y=r.defaultSymbol;!y||d||se(r)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:r.defaultLabel||"others",symbol:y}]}),a.infos.length&&n.unshift(a);const p=t.opacity==null?this.opacity:t.opacity,g=this._isTallSymbol("visualVariables"in r&&r.visualVariables),f=ue(this.layer)||xe(this.layer),_=n.reduce((h,w)=>h.concat(this._getAllInfos(w)),[]).filter(h=>!(h==null||!h.symbol)).map(h=>this._getSymbolPreview(h,p,{isDefault:h.symbol===y,applyScaleDrivenSize:!c.has(h.symbol),symbolConfig:{isTall:g,isSquareFill:f},effectList:c.has(h.symbol)?null:this.effectList}));return r=null,await J(_),n}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e==null?void 0:e.infos;return t?t.reduce((s,i)=>s.concat(this._getAllInfos(i)),[]):[e]}_constructTileImageryStretchRendererElements(e){var t,s;const i=this.layer,l=i.rasterInfo,r=l.bandCount||e.statistics.length;let n,a,o=[];const d=l.keyProperties&&l.keyProperties.BandProperties,c=e!=null&&(t=e.statistics)!=null&&t.length?e.statistics:l==null?void 0:l.statistics;if(c)n=c[0].min!==void 0?c[0].min:c[0][0],a=c[0].max||c[0][1];else{const p=ht[i.rasterInfo.pixelType.toLowerCase()];n=p[0],a=p[1]}if(i.hasStandardTime()&&(n=i.getStandardTimeValue(n),a=i.getStandardTimeValue(a)),l.bandCount===1||((s=i.bandIds)==null?void 0:s.length)===1)return this._getStretchLegendElements(e,{min:n,max:a});function y(p){var g;const f=(i!=null&&(g=i.bandIds)!=null&&g.length?i.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map(_=>p&&p[_]&&p[_].BandName||"band"+(_+1));return f.length<3?f.push(f[1]):f.length>3&&f.splice(3),f}return o=d&&d.length>=r?y(d):y(),this._createSymbolTableElementMultiBand(o)}_getStretchLegendElements(e,t){const s=e.colorRamp,i=ni(s,t);return{type:"stretch-ramp",title:"",infos:i,preview:Q(i.map(l=>l.color))}}async _getSizeLegendElement(e,t,s,i){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await vi(s,t,await Be(s),this.scale,this.view.type,i)}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach((i,l)=>{t.push({label:{colorName:s[l],bandName:i},src:ti[l],opacity:1})}),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",i=e.classBreakInfos.some(l=>je(l.symbol));if(s&&i){const l=Ne,r=Oe,n=e.classBreakInfos.length,a=(l-r)/(n>1?n-1:n);t.forEach((o,d)=>{o.size=l-a*d})}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let i=0;i<e.length&&(!t||!s);i++){const l=e[i];l.type==="size"&&(l.axis==="height"&&(t=!0),l.axis==="width-and-depth"&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let i=s!=null&&s.isDefault||e.size!=null||!this._hasSizeRamp?e.size:Ls(ws.size);if(this._scaleDrivenSizeVariable&&s!=null&&s.applyScaleDrivenSize){const{getSize:l}=await import("./vendor.c28ea743.js").then(function(r){return r.vA});i=l(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return Ss(e.symbol,{size:i,opacity:t,scale:!1,symbolConfig:s==null?void 0:s.symbolConfig,effectView:s==null?void 0:s.effectList}).then(l=>(e.preview=l,e)).catch(()=>(e.preview=null,e))}async _loadRenderer(e){var t,s;const i=[],l=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const r="visualVariables"in e&&((t=e.visualVariables)==null?void 0:t.some(a=>a.type==="size"&&a.target!=="outline"&&!ge.test(a.valueExpression)));if(e&&"visualVariables"in e&&!r&&"featureReduction"in l&&((s=l.featureReduction)==null?void 0:s.type)==="cluster"){const a=this.layerView._effectiveRenderer,o=Re(Gs(a,this.view));if(o){const d=l.featureReduction;if("clusterMinSize"in d&&"clusterMaxSize"in d){const{clusterMinSize:y,clusterMaxSize:p}=d;o.legendOptions=new Is({showLegend:y!==p})}const c=e.visualVariables||[];e.visualVariables=c.concat([o]),this._hasClusterSizeVariable=!0}}const n=await Be(e);if(ie(e)||qe(e)){const a=(e.classBreakInfos||e.uniqueValueInfos).map(o=>this._fetchSymbol(o.symbol,n).then(d=>{o.symbol=d}).catch(()=>{o.symbol=null}));Array.prototype.push.apply(i,a)}return i.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:n).then(a=>{this._applySymbolToRenderer(e,a,se(e))}).catch(()=>{this._applySymbolToRenderer(e,null,se(e))})),J(i).then(()=>e)}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}_fetchSymbol(e,t){if(!e)return Promise.reject();if(e.type==="web-style"){const s=e.portal,i=s&&s.url,l=s&&s.user&&s.user.username,r=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+i+"-"+l,n=this._webStyleSymbolCache;return n.has(r)||(this.view.type==="2d"?n.set(r,e.fetchCIMSymbol()):n.set(r,e.fetchSymbol())),n.get(r).then(a=>this._getAppliedCloneSymbol(a,t)).catch(()=>(U.warn("Fetching web-style failed!"),Promise.reject()))}return Promise.resolve(this._getAppliedCloneSymbol(e,t))}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const s=e.clone(),i=t&&t.toRgba();return s.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(s,i):s.type==="cim"?bt(s,t):s.color&&(s.color=new k(i||s.color)),s}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(s=>{s&&(s.material||(s.material={}),s.material.color=new k(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const s=e.visualVariables,i=[],l=[],r=[];for(const c of s)c.type==="color"?i.push(c):c.type==="size"?l.push(c):c.type==="opacity"&&r.push(c);const n=[...i,...l,...r];let a,o;if(i.length===0&&ie(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const c=e.classBreakInfos[0];a=c&&c.symbol}if(i.length===0&&se(e)&&(a=e.symbol),a)if(a.type.indexOf("3d")>-1){const c=a.symbolLayers.getItemAt(0);c.type==="water"?Ve(c.color)&&(o=c.color):Ve(c.material)&&Ve(c.material.color)&&(o=c.material.color)}else a.url||(o=a.color);const d=this.effectList;return(await Promise.all(n.map(async c=>{if(!c.legendOptions||c.legendOptions.showLegend!==!1){const y=De(e)?c.field:this._getRampTitle(c,t);let p=null;const g="getField"in t&&t.getField&&t.getField(c.field),f=g&&Cs(g);if(c.type==="color"){const _=await dt(c,null,f);p={type:"color-ramp",title:y,infos:_,preview:Q(_.map(h=>h.color),{effectList:d})},this._hasColorRamp||(this._hasColorRamp=!(p.infos==null||!p.infos.length))}else if(c.type==="size"&&c.target!=="outline")ge.test(c.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c):(p=await this._getSizeLegendElement(y,c,e,f),this._hasSizeRamp||(this._hasSizeRamp=!(p.infos==null||!p.infos.length)));else if(c.type==="opacity"){const _=await dt(c,o,f);p={type:"opacity-ramp",title:y,infos:_,preview:Q(_.map(h=>h.color),{effectList:d})},this._hasOpacityRamp||(this._hasOpacityRamp=!(p.infos==null||!p.infos.length))}return p&&p.infos?p:null}}))).filter(c=>!!c)}_getDomainName(e,t,s){if(e&&typeof e!="function"){const i="getField"in s&&s.getField&&s.getField(e),l=i&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(i.name):null;return l&&l.type==="coded-value"?l.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const i=t.featureReduction,l="popupTemplate"in i&&i.popupTemplate,r=l&&l.fieldInfos;if(r){for(const n of r)if(n.fieldName===s)return s==="cluster_count"?n.label||{showCount:!0}:n.label}}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,i=e.normalizationField,l=!1,r=!1,n=!1,a=null;s=typeof s=="function"?null:s,i=typeof i=="function"?null:i;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const d=t.renderer.authoringInfo.visualVariables;for(let c=0;c<d.length;c++){const y=d[c];if(y.type==="color"){if(y.style==="ratio"){l=!0;break}if(y.style==="percent"){r=!0;break}if(y.style==="percent-of-total"){n=!0;break}}}}a={field:s&&this._getFieldAlias(s,t),normField:i&&this._getFieldAlias(i,t),ratio:l,ratioPercent:r,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let i=s.field,l=null,r=null;ie(s)&&(l=s.normalizationField,r=s.normalizationType==="percent-of-total"),i=typeof i=="function"?null:i,l=typeof l=="function"?null:l;let n=null;return(i||l)&&(n={field:i&&this._getFieldAlias(i,t),normField:l&&this._getFieldAlias(l,t),normByPct:r}),n}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,i=s&&s.fieldInfos;let l=null;i&&i.some(o=>e===o.fieldName&&(l=o,!0));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));const n=l||r;let a=null;return n&&(a=l&&l.label||r&&r.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName),a}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return ie(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(s=e.field?t.some(i=>!(!i||e.field!==i.field||(e.normalizationField||i.normalizationField)&&e.normalizationField!==i.normalizationField)):!!t.length),s}};m([S()],V.prototype,"children",void 0),m([S({readOnly:!0})],V.prototype,"effectList",null),m([S()],V.prototype,"layerView",void 0),m([S()],V.prototype,"layer",void 0),m([S()],V.prototype,"legendElements",void 0),m([S({readOnly:!0})],V.prototype,"opacity",null),m([S()],V.prototype,"parent",void 0),m([S({readOnly:!0,dependsOn:[]})],V.prototype,"ready",null),m([S()],V.prototype,"hideLayersNotInCurrentView",void 0),m([S()],V.prototype,"keepCacheOnDestroy",void 0),m([S()],V.prototype,"respectLayerVisibility",void 0),m([S({readOnly:!0})],V.prototype,"scale",null),m([S()],V.prototype,"sublayerIds",void 0),m([S({readOnly:!0})],V.prototype,"isScaleDriven",null),m([S()],V.prototype,"title",void 0),m([S({readOnly:!0,dependsOn:["ready"],value:0})],V.prototype,"version",null),m([S()],V.prototype,"view",void 0),V=m([oe("esri.widgets.Legend.support.ActiveLayerInfo")],V);const Ot=V,G={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},Dt=Ge.ofType(Ot),Qi=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer"],qt="view.basemapView.baseLayerViews",Pt="view.groundView.layerViews",Ht="view.basemapView.referenceLayerViews",Ki=[qt,Pt,"view.layerViews",Ht];let M=class extends He{constructor(e){super(e),this._handles=new $e,this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Ge,this.activeLayerInfos=new Dt,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this._handles.add(ye(this,"view",this._viewHandles),G.view),this._handles.add(As(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this._handles.remove(G.state),this.view&&this._handles.add(ye(this,"state",this._stateHandles),G.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this._handles.remove([G.allLayerViews,G.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",this._allLayerViewsChangeHandle.bind(this)),G.allLayerViews),this._handles.add(F(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),G.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){if(e.length<2)return;const t=[];e.forEach(i=>{if(!i.parent){const l=i.layer.parent,r=l&&"uid"in l&&this._layerViewByLayerId[l.uid],n=r&&this._activeLayerInfosByLayerViewId[r.uid];n&&e.indexOf(n)!==-1&&(t.push(i),i.parent=n,n.children.add(i),this._sortActiveLayerInfos(n.children))}}),e.removeMany(t);const s={};this.view.allLayerViews.forEach((i,l)=>s[i.layer.uid]=l),e.sort((i,l)=>{const r=s[i.layer.uid]||0;return(s[l.layer.uid]||0)-r})}_generateLayerViews(){const e=[];return Ki.filter(this._filterLayerViews,this).map(this.get,this).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===qt||e===Ht),s=!this.groundLegendVisible&&e===Pt;return!t&&!s}_collectLayerViews(e,t){const s=i=>(i&&i.forEach(l=>{t.push(l),s(l[e])}),t);return s}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(s=>this._hasLayerInfo(s,e))}_hasLayerInfo(e,t){const s=this._isLayerUIDMatching(e.layer,t.layer.uid);return s&&(this._layerInfosByLayerViewId[t.uid]=e),s}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(s=>this._isLayerUIDMatching(s,t))}_isLayerViewSupported(e){return!!Qi.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add(F(e,"legendEnabled, layer.legendEnabled",()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")}_buildActiveLayerInfo(e){var t;const s=e.layer,i=e.uid,l=this._layerInfosByLayerViewId[i];let r=this._activeLayerInfosByLayerViewId[i];if(!r){const a=l&&l.title!==void 0&&l.layer.uid===s.uid;r=new Ot({layer:s,layerView:e,title:a?l.title:s.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:l&&l.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=r}const n=s.parent&&"uid"in s.parent&&this._layerViewByLayerId[(t=s.parent)==null?void 0:t.uid];if(r.parent=this._activeLayerInfosByLayerViewId[n==null?void 0:n.uid],!this._handles.has(i)){const a=[F(s,"title",o=>this._titleHandle(o,r)),F(s,"renderer?, opacity, pointSymbol?, lineSymbol?, polygonSymbol?",()=>this._constructLegendElements(r)),$s(this.view,"stationary",()=>this._scaleHandle(r)),F(e,"_effectiveRenderer",()=>this._constructLegendElements(r)),F(s,"effect",()=>this._constructLegendElements(r))];if(this.respectLayerVisibility){const o=F(e,"legendEnabled",c=>this._legendEnabledHandle(c,r)),d=F(s,"legendEnabled",c=>this._legendEnabledHandle(c,r));a.push(o,d)}this._handles.add(a,i)}r.isScaleDriven||this._constructLegendElements(r),this._addActiveLayerInfo(r)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:t,layer:s}=e;if(this._isLayerActive(t)&&this.activeLayerInfos.indexOf(e)===-1){const l=e.parent;if(l)l.children.indexOf(e)===-1&&l.children.push(e),this._sortActiveLayerInfos(l.children);else{var i;const r=(i=this.layerInfos)==null?void 0:i.some(n=>n.layer.uid===s.uid);s.parent&&"uid"in s.parent&&!r?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const r=[];this._activeLayerInfosWithNoParent.forEach(n=>{const a=n.layer.parent,o=a&&"uid"in a&&this._layerViewByLayerId[a==null?void 0:a.uid],d=this._activeLayerInfosByLayerViewId[o==null?void 0:o.uid];d&&(r.push(n),n.parent=d)}),r.length&&(this._activeLayerInfosWithNoParent.removeMany(r),r.forEach(n=>this._addActiveLayerInfo(n)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"renderer"in t&&t.renderer?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach(s=>this._constructLegendElements(s))}};m([S({type:Dt})],M.prototype,"activeLayerInfos",void 0),m([S()],M.prototype,"basemapLegendVisible",void 0),m([S()],M.prototype,"groundLegendVisible",void 0),m([S()],M.prototype,"hideLayersNotInCurrentView",void 0),m([S()],M.prototype,"keepCacheOnDestroy",void 0),m([S()],M.prototype,"respectLayerVisibility",void 0),m([S()],M.prototype,"layerInfos",void 0),m([S({readOnly:!0})],M.prototype,"state",null),m([S()],M.prototype,"view",void 0),M=m([oe("esri.widgets.Legend.LegendViewModel")],M);const Ji=M,Xi="http://www.w3.org/2000/svg",$={diamondContainer:"esri-relationship-ramp--diamond__container",diamondLeftCol:"esri-relationship-ramp--diamond__left-column",diamondRightCol:"esri-relationship-ramp--diamond__right-column",diamondMidCol:"esri-relationship-ramp--diamond__middle-column",diamondMidColLabel:"esri-relationship-ramp--diamond__middle-column--label",diamondMidColRamp:"esri-relationship-ramp--diamond__middle-column--ramp",squareTable:"esri-relationship-ramp--square__table",squareTableRow:"esri-relationship-ramp--square__table-row",squareTableCell:"esri-relationship-ramp--square__table-cell",squareTableLabel:"esri-relationship-ramp--square__table-label",squareTableLabelLeftBottom:"esri-relationship-ramp--square__table-label--left-bottom",squareTableLabelRightBottom:"esri-relationship-ramp--square__table-label--right-bottom",squareTableLabelLeftTop:"esri-relationship-ramp--square__table-label--left-top",squareTableLabelRightTop:"esri-relationship-ramp--square__table-label--right-top"};function Ut(e,t,s,i){const{focus:l,labels:r}=e,n=!!l,a=Yi(e,t,s,i),o={justifyContent:"center"},d=Fe();return n?u("div",{class:$.diamondContainer,styles:o},u("div",{class:$.diamondLeftCol},d?r.right:r.left),u("div",{class:$.diamondMidCol},u("div",{class:$.diamondMidColLabel},r.top),a,u("div",{class:$.diamondMidColLabel},r.bottom)),u("div",{class:$.diamondRightCol},d?r.left:r.right)):u("div",{class:$.squareTable},u("div",{class:$.squareTableRow},u("div",{class:fe($.squareTableCell,$.squareTableLabel,$.squareTableLabelRightBottom)},d?r.top:r.left),u("div",{class:$.squareTableCell}),u("div",{class:fe($.squareTableCell,$.squareTableLabel,$.squareTableLabelLeftBottom)},d?r.left:r.top)),u("div",{class:$.squareTableRow},u("div",{class:$.squareTableCell}),a,u("div",{class:$.squareTableCell})),u("div",{class:$.squareTableRow},u("div",{class:fe($.squareTableCell,$.squareTableLabel,$.squareTableLabelRightTop)},d?r.right:r.bottom),u("div",{class:$.squareTableCell}),u("div",{class:fe($.squareTableCell,$.squareTableLabel,$.squareTableLabelLeftTop)},d?r.bottom:r.right)))}function mt(e,t,s){const i=`${s}_arrowStart`,l=`${s}_arrowEnd`,r=e==="left",n={markerStart:null,markerEnd:null};switch(t){case"HL":r?n.markerStart=`url(#${l})`:n.markerEnd=`url(#${i})`;break;case"LL":n.markerStart=`url(#${l})`;break;case"LH":r?n.markerEnd=`url(#${i})`:n.markerStart=`url(#${l})`;break;default:n.markerEnd=`url(#${i})`}return n}function Yi(e,t,s,i,l=60){const{focus:r,numClasses:n,colors:a,rotation:o}=e,d=!!r,c=Math.sqrt(l**2+l**2)+(d?0:5),y=[],p=[],g=[],f=(l||75)/n;for(let R=0;R<n;R++){const P=R*f;for(let q=0;q<n;q++){const ce=q*f,tt=ks(a[R][q]),Xt=Ms(null),st={type:"rect",x:ce,y:P,width:f,height:f};y.push(Bs(tt)),p.push(Ns(st,tt.fill,Xt,null)),g.push(Os(st))}}const _=10,h=15,w=15,b=10;let C=null;d||(C="margin: -15px -15px -18px -15px");const I=mt("left",r,t),A=mt("right",r,t),E=Ds(g),T=at(E,c,c,0,!1,o,!1),j=at(E,c,c,0,!1,d?-45:null,!1),N={filter:ke(i),opacity:s==null?null:`${s}`};return u("div",{styles:N,class:d?$.diamondMidColRamp:$.squareTableCell},u("svg",{xmlns:Xi,width:c,height:c,style:C},u("defs",null,u("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},u("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),u("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},u("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),y),u("g",{transform:T},p),u("g",{transform:j},u("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":I.markerStart,"marker-end":I.markerEnd,x1:-_,y1:l-h,x2:-_,y2:h}),u("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":A.markerStart,"marker-end":A.markerEnd,x1:w,y1:l+b,x2:l-w,y2:l+b}))))}const Zi=Es(),Wt=10,Ye=20,Ee=10,Ze=20,et={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function el(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?u("svg",{height:"4",width:"10"},u("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):u("svg",{height:"10",width:"10"},u("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function tl(e,t="vertical"){const s=document.createElement("div");return s.style.height=`${Ye}px`,s.className=et.univariateAboveAndBelowSymbol,e!=null&&(s.style.opacity=e.toString()),Zi.append(s,el.bind(null,t)),s}function jt(e,t,s="vertical",i){e.infos.forEach((l,r)=>{if(i&&r===2)l.preview=tl(t,s);else{const n=W(l.size)+(s==="horizontal"?Ze:Ee),a=l.preview.tagName.toLowerCase()==="div",o=a?l.preview:document.createElement("div");o.className=et.univariateAboveAndBelowSymbol,s==="horizontal"?o.style.width=`${n}px`:o.style.height=`${n}px`,a||o.appendChild(l.preview),l.preview=o}})}function Ae(e,t="classic"){const s=e.infos;return t==="classic"?(W(s[0].size)+Ee)/2:(W(s[0].size)-W(s[s.length-1].size))/2}function re(e,t){if(!e)return null;const s=e.infos.map(l=>l.color),i=Q(t.type==="full"?s:t.type==="above"?s.slice(0,3):s.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList});return i.className=et.colorRamp,t.opacity!=null&&(i.style.opacity=t.opacity.toString()),i}function Pe(e,t,s,i="vertical"){let l=0;const r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n;for(let d=a;d<=o;d++)s&&d===n?l+=i==="horizontal"?Wt:Ye:l+=W(r[d].size)+(i==="horizontal"?Ze:Ee);return Math.round(l)}function ne(e,t,s,i="vertical"){const l=Pe(e,t,s,i),r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n,d=t==="full"?r[a].size+r[o].size:t==="above"?r[a].size:r[o].size,c=s?i==="vertical"?Ye:Wt:0,y=i==="vertical"?Ee*(t==="full"?2:1):Ze*(t==="full"?2:1);return Math.round(l-(W(d)/2+c/2+y/2))}function Gt(e,t,s="vertical"){const i=e.infos;let l=i.find(({type:o})=>o==="size-ramp"),r=i.find(({type:o})=>o==="color-ramp");var n,a;return l&&(l=O({},l),l.infos=[...l.infos],jt(l,t,s,!0)),r&&(r=O({},r),r.infos=[...r.infos]),s==="horizontal"&&((n=l)==null||n.infos.reverse(),(a=r)==null||a.infos.reverse()),{sizeRampElement:l,colorRampElement:r}}function Qt(e,t="vertical"){const s=e.infos;let i=s.find(({type:a})=>a==="size-ramp"),l=s.find(({type:a})=>a==="color-ramp");var r,n;return i&&(i=O({},i),i.infos=[...i.infos],jt(i,null,t,!1)),l&&(l=O({},l),l.infos=[...l.infos]),t==="horizontal"&&((r=i)==null||r.infos.reverse(),(n=l)==null||n.infos.reverse()),{sizeRampElement:i,colorRampElement:l}}function sl(e,t){return t}function z(e){const t=this;e.appendChild(t)}function ae(e,t,s){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Me(e.dotValue,t);if("colorName"in t||"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:null;let i=null;return sl(t,s)?i=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:Kt(t,s)&&(i=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),i?Me(i==="showField"?"{field}":e[i],{field:t.field,normField:t.normField}):null}function Kt(e,t){return!t}function Jt(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const v={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},il=25,ll=25,rl=768,nl=100;var he;(function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"})(he||(he={}));const al="#ddd",Y=window.devicePixelRatio;function ol(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return i==="circle"||i==="cross"||i==="kite"||i==="sphere"||i==="cube"||i==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function cl(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return s==="triangle"||s==="cone"||s==="tetrahedron"}return e.style==="triangle"}}let B=class extends Qe{constructor(e,t){super(e,t),this._handles=new $e,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=he.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own([this.watch("activeLayerInfos",e=>{this._handles.removeAll(),this._watchForSectionChanges(e)})])}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout===he.Auto&&this.view.container.clientWidth<=rl||this.layout===he.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map(a=>this._renderLegendForLayer(a)).filter(a=>!!a);this._hasIndicators?this._selectedSectionName&&this._sectionNames.indexOf(this._selectedSectionName)!==-1||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map((a,o)=>{const d=Me(this.messagesCommon.pagination.pageText,{index:o+1,total:s});return u("div",{key:a,role:"tab",id:a,"aria-label":d,"aria-controls":`${a}-panel`,"aria-selected":(this._selectedSectionName===a).toString(),tabIndex:this._selectedSectionName===a?0:-1,title:d,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(v.indicator,{[v.activated]:this._selectedSectionName===a}),"data-section-name":a})}),l=this._hasIndicators&&s>1?u("div",{class:v.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,n={[v.stacked]:this._hasIndicators};return u("div",{class:this.classes(v.base,n)},r||u("div",{class:v.message},this.messages.noLegend),l)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s=t==="ArrowLeft"?-1:1,i=e.target.getAttribute("data-section-name"),l=this._sectionNames.indexOf(i),r=this._sectionNames;let n=null;l!==-1&&(r[l+s]?n=document.getElementById(r[l+s]):t==="ArrowLeft"?n=document.getElementById(r[r.length-1]):t==="ArrowRight"&&(n=document.getElementById(r[0])),n&&n.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(s=>{const i=`activeLayerInfo-${s.layer.uid}-version-change`;this._handles.remove(i),this._watchForSectionChanges(s.children),this._handles.add(s.watch("version",()=>this._generateSectionNames()),i)});const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(s=>this._renderLegendForLayer(s)).toArray();return u("div",{key:e.layer.uid,class:this.classes(v.service,v.groupLayer)},u("div",{class:v.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some(r=>r.type==="relationship-ramp"),i=t.map((r,n)=>this._renderLegendForElement(r,e,n,s)).filter(r=>!!r);if(!i.length)return null;const l={[v.groupLayerChild]:!!e.parent};return u("div",{key:e.layer.uid,class:this.classes(v.service,l)},u("div",{class:v.serviceCaptionContainer},u("div",{class:v.serviceCaptionText},e.title)),u("div",{class:v.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp",a=t.layer;let o=null;if(typeof e.title=="string")o=e.title;else if(e.title){const f=e.title,_=ae(this.messages,f,l||r);o=f.title?`${f.title} (${_})`:_}const d=this._getSectionName(a,e,s),c=this._hasIndicators?u("div",null,u(Le,{level:this.headingLevel,class:v.carouselTitle},t.title),u(Le,{level:Vs(this.headingLevel),class:v.layerCaption},o)):o?u(Le,{level:this.headingLevel,class:v.layerCaption},o):null,y=t.effectList;let p=null;if(e.type==="symbol-table"){const f=e.infos.map((_,h)=>this._renderLegendForElementInfo(_,t,e.legendType,h)).filter(_=>!!_);if(f.length){const _=f[0].properties.classes&&f[0].properties.classes[v.symbolRow],h={[v.labelContainer]:!_&&!i,[v.relationshipLabelContainer]:i};p=u("div",{class:this.classes(h)},f)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?p=this._renderLegendForRamp(e,a.opacity,y):n?p=this._renderSizeRamp(e,a.opacity):e.type==="relationship-ramp"?p=Ut(e,this.id,a.opacity,y):e.type==="univariate-above-and-below-ramp"?p=this._renderUnivariateAboveAndBelowRamp(e,a.opacity,y):e.type==="univariate-color-size-ramp"&&(p=this._renderUnivariateColorSizeRamp(e,a.opacity,y));if(!p)return null;const g=u("div",{key:d,class:v.section,id:`${d}-panel`,role:"tabpanel","aria-labelledby":d,tabIndex:0},[c,p]);return this._sectionMap.set(d,g),g}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Gt(e,t,"horizontal");if(!i)return null;const r=Pe(i,"full",!0,"horizontal"),n=ne(i,"above",!0,"horizontal"),a=ne(i,"below",!0,"horizontal"),o=12,d=re(l,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s}),c=re(l,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s}),y=Ae(i,"card"),p=i.infos.map(C=>C.label),g=p.length-1,f=p.map((C,I)=>I===0||I===g?u("div",{key:I},C):null),_={display:"flex",flexDirection:"column"},h={display:"flex",flexDirection:"row"},w={marginTop:"3px",display:"flex"};Fe(this.container)?w.marginRight=`${y}px`:w.marginLeft=`${y}px`;const b={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return u("div",{class:v.layerRow,key:"size-ramp-preview",styles:_},u("div",{class:this.classes(v.symbolContainer,v.sizeRampHorizontal),styles:h},i.infos.map((C,I)=>u("div",{key:I,class:v.symbol,bind:C.preview,afterCreate:z}))),d?u("div",{class:v.univariateAboveAndBelowColorRamp,styles:w,key:"color-ramp-preview"},u("div",{bind:d,afterCreate:z}),u("div",{bind:c,afterCreate:z})):null,u("div",{class:v.layerInfo},u("div",{class:v.rampLabelsContainer,styles:b},f)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Qt(e,"horizontal");if(!i)return null;const r=Pe(i,"full",!1,"horizontal"),n=ne(i,"full",!1,"horizontal"),a=re(l,{width:n,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s}),o=Ae(i,"card"),d=i.infos.length-1,c=i.infos.map((_,h)=>h===0||h===d?u("div",{key:h},_.label):null),y={display:"flex",flexDirection:"column"},p={display:"flex",flexDirection:"row"},g={marginTop:"3px",display:"flex"};Fe(this.container)?g.marginRight=`${o}px`:g.marginLeft=`${o}px`;const f={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return u("div",{class:v.layerRow,key:"size-ramp-preview",styles:y},u("div",{class:this.classes(v.symbolContainer,v.sizeRampHorizontal),styles:p},i.infos.map((_,h)=>u("div",{key:h,class:v.symbol,bind:_.preview,afterCreate:z}))),u("div",{class:v.univariateAboveAndBelowColorRamp,styles:g,key:"color-ramp-preview"},u("div",{bind:a,afterCreate:z})),u("div",{class:v.layerInfo},u("div",{class:v.rampLabelsContainer,styles:f},c)))}_renderLegendForElementInfo(e,t,s,i){const l=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const r=Jt(l,s);if(e.preview){var n,a;if(!e.symbol||e.symbol.type.indexOf("simple-fill")===-1){if(!e.label)return u("div",{key:i,bind:e.preview,afterCreate:z});const A={[v.symbolCell]:this._hasIndicators};return u("div",{key:i,class:this.classes(v.layerRow,{[v.symbolRow]:this._hasIndicators})},u("div",{class:this.classes(A),bind:e.preview,afterCreate:z}),u("div",{class:this.classes(v.imageLabel,{[v.labelCell]:this._hasIndicators})},ae(this.messages,e.label,!1)||""))}let o=255,d=255,c=255,y=0,p=255,g=255,f=255,_=0;const h=e.symbol.color&&e.symbol.color.a,w=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;h&&(o=e.symbol.color.r,d=e.symbol.color.g,c=e.symbol.color.b,y=e.symbol.color.a*l.opacity),w&&(p=e.symbol.outline.color.r,g=e.symbol.outline.color.g,f=e.symbol.outline.color.b,_=e.symbol.outline.color.a*l.opacity);const b=(n=(a=e.symbol.color)==null?void 0:a.isBright)==null||n,C=b?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",I={background:h?`rgba(${o}, ${d}, ${c}, ${y})`:"none",color:b?"black":"white",textShadow:`-1px -1px 0 ${C},
                                              1px -1px 0 ${C},
                                              -1px 1px 0 ${C},
                                              1px 1px 0 ${C}`,border:w?`1px solid rgba(${p}, ${g}, ${f}, ${_})`:"none",filter:ke(t.effectList)};return u("div",{key:i,class:v.layerRow},u("div",{class:v.labelElement,styles:I}," ",e.label," "))}if(e.src){const o=this._renderImage(e,l,r);return u("div",{key:i,class:v.layerRow},o,u("div",{class:v.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:i,src:l,opacity:r}=e,n={[v.imageryLayerStretchedImage]:s,[v.symbol]:!s},a={opacity:`${r!=null?r:t.opacity}`};return u("img",{alt:ae(this.messages,i,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}_renderSizeRampLines(e){const t=e.infos,s=t[0],i=t[t.length-1],l=s.symbol,r=this._hasIndicators,n=W(s.size+s.outlineSize)*Y,a=W(i.size+i.outlineSize)*Y,o=r?n:n+50*Y,d=r?n/2+50*Y:n,c=cl(l),y=ol(l),p=document.createElement("canvas");p.width=o,p.height=d,p.style.width=p.width/Y+"px",p.style.height=p.height/Y+"px";const g=p.getContext("2d");if(r){g.beginPath();const f=0,_=0,h=o/2-a/2,w=d;g.moveTo(f,_),g.lineTo(h,w);const b=o,C=0,I=o/2+a/2,A=d;g.moveTo(b,C),g.lineTo(I,A)}else{g.beginPath();const f=0,_=d/2-a/2,h=o,w=0;g.moveTo(f,_),g.lineTo(h,w);const b=0,C=d/2+a/2,I=o,A=d;g.moveTo(b,C),g.lineTo(I,A)}return g.strokeStyle=al,g.stroke(),u("div",{bind:p,afterCreate:z,styles:r?{display:"flex",marginTop:`-${c?0:y?n/2:0}px`,marginBottom:`-${c?a:y?a/2:0}px`}:{display:"flex",marginRight:`-${c?0:y?n/2:0}px`,marginLeft:`-${c?0:y?a/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,l=s[s.length-1].label;let r=s[0].preview,n=s[s.length-1].preview;const a=this._hasIndicators,o={"flex-direction":a?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),n&&(n=n.cloneNode(!0),n.style.display="flex");const d={opacity:t!=null?`${t}`:""};return u("div",{class:this.classes(v.layerRow,{[v.sizeRampRow]:a})},u("div",{class:v.rampLabel},a?i:l),u("div",{class:v.sizeRampContainer,styles:o},u("div",{bind:r,afterCreate:z,class:v.sizeRampPreview,styles:d}),this._renderSizeRampLines(e),u("div",{bind:n,afterCreate:z,class:v.sizeRampContainer,styles:d})),u("div",{class:v.rampLabel},a?l:i))}_renderLegendForRamp(e,t,s){const i=e.infos,l=e.type==="heatmap-ramp",r=i.length-1,n=ll,a=r>2&&!l?il*r:nl,o=a+20,d=10,c=i.slice(0).reverse();c.forEach((A,E)=>{A.offset=l?A.ratio:E/r});const y=c.length-1,p=c.length%2!=0&&c[c.length/2|0],g=p&&u("div",{class:v.intervalSeparatorsContainer},u("div",{class:v.intervalSeparator},"|"),u("div",{class:v.rampLabel},p.label)),f=i[i.length-1].label,_=i[0].label,h=[[{shape:{type:"path",path:`M0 ${n/2} L${d} 0 L${d} ${n} Z`},fill:c[0].color,stroke:{width:0}},{shape:{type:"rect",x:d,y:0,width:a,height:n},fill:{type:"linear",x1:d,y1:0,x2:a+d,y2:0,colors:c},stroke:{width:0}},{shape:{type:"path",path:`M${a+d} 0 L${o} ${n/2} L${a+d} ${n} Z`},fill:c[y].color,stroke:{width:0}}]],w=qs(h,o,n),{messages:b}=this,C={filter:ke(s),opacity:t==null?null:`${t}`},I={justifyContent:"center"};return u("div",{class:v.layerRow,styles:I},u("div",{class:v.rampLabel},l?b[f]:f),u("div",{class:v.symbolContainer},u("div",{styles:C},w),g),u("div",{class:v.rampLabel},l?b[_]:_))}};m([S()],B.prototype,"activeLayerInfos",void 0),m([S()],B.prototype,"headingLevel",void 0),m([S()],B.prototype,"layout",void 0),m([S(),Se("esri/widgets/Legend/t9n/Legend")],B.prototype,"messages",void 0),m([S(),Se("esri/t9n/common")],B.prototype,"messagesCommon",void 0),m([S({readOnly:!0})],B.prototype,"type",void 0),m([S()],B.prototype,"view",void 0),m([Rs()],B.prototype,"_selectSection",null),B=m([oe("esri.widgets.Legend.styles.Card")],B);const ze=B,L={service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"},dl="esri-legend__",ul=24,ft={display:"flex",alignItems:"flex-start"},Te={marginLeft:"3px"},Z={display:"table-cell",verticalAlign:"middle"};let K=class extends Qe{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(s=>this._renderLegendForLayer(s)).filter(s=>!!s);return u("div",null,t&&t.length?t:u("div",{class:L.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,s=`${dl}${e.layer.uid}-version-${e.version}`,i=e.title?Le({level:this.headingLevel,class:this.classes(L.header,L.label)},e.title):null;if(t){const l=e.children.map(r=>this._renderLegendForLayer(r)).toArray();return u("div",{key:s,class:this.classes(L.service,L.groupLayer)},i,l)}{const l=e.legendElements;if(l&&!l.length)return null;const r=l.map(a=>this._renderLegendForElement(a,e.layer,e.effectList)).filter(a=>!!a);if(!r.length)return null;const n={[L.groupLayerChild]:!!e.parent};return u("div",{key:s,class:this.classes(L.service,n),tabIndex:0},i,u("div",{class:L.layer},r))}}_renderLegendForElement(e,t,s,i){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp";let a=null;if(e.type==="symbol-table"||n){const g=e.infos.map(f=>this._renderLegendForElementInfo(f,t,s,n,e.legendType)).filter(f=>!!f);g.length&&(a=u("div",{class:L.layerBody},g))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?a=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?a=Ut(e,this.id,t.opacity,s):e.type==="univariate-above-and-below-ramp"?a=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,s):e.type==="univariate-color-size-ramp"&&(a=this._renderUnivariateColorSizeRamp(e,t.opacity,s));if(!a)return null;const o=e.title;let d=null;if(typeof o=="string")d=o;else if(o){const g=ae(this.messages,o,l||r);d=Kt(o,l||r)&&o.title?`${o.title} (${g})`:g}const c=i?L.layerChildTable:L.layerTable,y=d?u("div",{class:L.layerCaption},d):null,p={[L.layerTableSizeRamp]:n||!i};return u("div",{class:this.classes(c,p)},y,a)}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Gt(e,t);if(!i)return null;const r=ne(i,"above",!0),n=ne(i,"below",!0),a=12,o=re(l,{width:a,height:r,rampAlignment:"vertical",opacity:t,type:"above",effectList:s}),d=re(l,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"below",effectList:s}),c=Ae(i),y=i.infos.map(I=>I.label),p=y.map((I,A)=>A===0?u("div",{key:A,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):A===2?u("div",null):null),g=y.length-1,f=Math.floor(y.length/2),_=y.map((I,A)=>A===f||A===g?u("div",{key:A,class:I?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},I):null),h={display:"table-cell",verticalAlign:"middle"},w={marginTop:`${c}px`},b={height:`${r}px`},C={height:`${n}px`};return u("div",{key:"univariate-above-and-below-ramp-preview",styles:ft},u("div",{class:L.layerBody},i.infos.map((I,A)=>u("div",{class:this.classes(L.layerRow,L.sizeRamp)},u("div",{class:L.symbol,styles:h,bind:I.preview,afterCreate:z}),o||A%2!=0?null:u("div",{class:L.layerInfo},y[A])))),o?u("div",{styles:w,key:"color-ramp-preview"},u("div",{styles:Te},u("div",{styles:Z},u("div",{class:L.rampContainer,bind:o,afterCreate:z})),u("div",{styles:Z},u("div",{class:L.rampLabelsContainer,styles:b},p))),u("div",{styles:Te},u("div",{styles:Z},u("div",{class:L.rampContainer,bind:d,afterCreate:z})),u("div",{styles:Z},u("div",{class:L.rampLabelsContainer,styles:C},_)))):null)}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Qt(e);if(!i)return null;const r=Ae(i),n=12,a=ne(i,"full",!1),o=re(l,{width:n,height:a,rampAlignment:"vertical",opacity:t,type:"full",effectList:s}),d=i.infos.length-1,c=i.infos.map((f,_)=>_===0||_===d?u("div",{key:_,class:f.label?l?L.univariateAboveAndBelowLabel:L.rampLabel:null},f.label):null),y={display:"table-cell",verticalAlign:"middle"},p={marginTop:`${r}px`},g={height:`${a}px`};return u("div",{key:"univariate-above-and-below-ramp-preview",styles:ft},u("div",{class:L.layerBody},i.infos.map(f=>u("div",{class:this.classes(L.layerRow,L.sizeRamp)},u("div",{class:L.symbol,styles:y,bind:f.preview,afterCreate:z})))),u("div",{styles:p,key:"color-ramp-preview"},u("div",{styles:Te},u("div",{styles:Z},u("div",{class:L.rampContainer,bind:o,afterCreate:z})),u("div",{styles:Z},u("div",{class:L.rampLabelsContainer,styles:g},c)))))}_renderLegendForRamp(e,t){const s=e.infos,i=e.type==="opacity-ramp",l=e.type==="heatmap-ramp",r=e.type==="stretch-ramp",n=e.preview,a=i?L.opacityRamp:"";n.className=`${L.colorRamp} ${a}`,t!=null&&(n.style.opacity=t.toString());const o=s.map(y=>u("div",{class:y.label?L.rampLabel:null},l?this.messages[y.label]:r?this._getStretchStopLabel(y):y.label)),d={width:`${ul}px`},c={height:n.style.height};return u("div",{class:L.layerRow},u("div",{class:L.symbolContainer,styles:d},u("div",{class:L.rampContainer,bind:n,afterCreate:z})),u("div",{class:L.layerInfo},u("div",{class:L.rampLabelsContainer,styles:c},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:We(e.value,{style:"decimal",notation:e.value.toString().indexOf("e")>-1?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,s,i,l){if(e.type)return this._renderLegendForElement(e,t,s,!0);let r=null;const n=Jt(t,l);if(e.preview?r=u("div",{class:L.symbol,bind:e.preview,afterCreate:z}):e.src&&(r=this._renderImage(e,t,n)),!r)return null;const a={[L.imageryLayerInfoStretched]:n},o={[L.imageryLayerInfoStretched]:n,[L.sizeRamp]:!n&&i};return u("div",{class:L.layerRow},u("div",{class:this.classes(L.symbolContainer,o)},r),u("div",{class:this.classes(L.layerInfo,a)},ae(this.messages,e.label,!1)||""))}_renderImage(e,t,s){const{label:i,src:l,opacity:r}=e,n={[L.imageryLayerStretchedImage]:s,[L.symbol]:!s},a={opacity:`${r!=null?r:t.opacity}`};return u("img",{alt:ae(this.messages,i,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}};m([S()],K.prototype,"activeLayerInfos",void 0),m([S()],K.prototype,"headingLevel",void 0),m([S(),Se("esri/widgets/Legend/t9n/Legend")],K.prototype,"messages",void 0),m([S({readOnly:!0})],K.prototype,"type",void 0),K=m([oe("esri.widgets.Legend.styles.Classic")],K);const ee=K,ve={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let x=class extends Qe{constructor(e,t){super(e,t),this._handles=new $e,this.activeLayerInfos=null,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.headingLevel=3,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.iconClass=ve.widgetIcon,this.label=void 0,this.layerInfos=null,this.messages=null,this.style=new ee,this.view=null,this.viewModel=new Ji}initialize(){this.own(_e(this,"view","resize",()=>this.scheduleRender()),_e(this,"activeLayerInfos","change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),F(this,"headingLevel",e=>{const{style:t}=this;t&&(t.headingLevel=e)}),ye(this,"style",(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)}))}destroy(){this._handles.destroy(),this._handles=null}castStyle(e){if(e instanceof ze||e instanceof ee)return e;if(typeof e=="string")return e==="card"?new ze:new ee;if(e&&typeof e.type=="string"){const t=O({},e);return delete t.type,new(e.type==="card"?ze:ee)(t)}return new ee}render(){return u("div",{class:this.classes(ve.base,ve.widget,this.style instanceof ee?ve.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){this._handles.removeAll(),e.forEach(t=>this._renderOnActiveLayerInfoChange(t)),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=ye(e,"version",()=>this.scheduleRender());this._handles.add(t,`version_${e.layer.uid}`);const s=_e(e,"children","change",()=>{e.children.forEach(i=>this._renderOnActiveLayerInfoChange(i))});this._handles.add(s,`children_${e.layer.uid}`),e.children.forEach(i=>this._renderOnActiveLayerInfoChange(i))}};m([H("viewModel.activeLayerInfos")],x.prototype,"activeLayerInfos",void 0),m([H("viewModel.basemapLegendVisible")],x.prototype,"basemapLegendVisible",void 0),m([H("viewModel.groundLegendVisible")],x.prototype,"groundLegendVisible",void 0),m([S()],x.prototype,"headingLevel",void 0),m([H("viewModel.hideLayersNotInCurrentView")],x.prototype,"hideLayersNotInCurrentView",void 0),m([H("viewModel.keepCacheOnDestroy")],x.prototype,"keepCacheOnDestroy",void 0),m([H("viewModel.respectLayerVisibility")],x.prototype,"respectLayerVisibility",void 0),m([S()],x.prototype,"iconClass",void 0),m([S({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],x.prototype,"label",void 0),m([H("viewModel.layerInfos")],x.prototype,"layerInfos",void 0),m([S(),Se("esri/widgets/Legend/t9n/Legend")],x.prototype,"messages",void 0),m([S()],x.prototype,"style",void 0),m([xs("style")],x.prototype,"castStyle",null),m([H("viewModel.view")],x.prototype,"view",void 0),m([S()],x.prototype,"viewModel",void 0),x=m([oe("esri.widgets.Legend")],x);const Ll=x;export{Ll as default};
